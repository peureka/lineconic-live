<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>LINECONIC LIVE</title>
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#000000">
<link rel="icon" type="image/svg+xml" href="/favicon.svg">
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
<script src="https://unpkg.com/sortablejs@1.15.6/Sortable.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Anton&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
/* ═══════════════════════════════════════
   DESIGN SYSTEM V1 TOKENS
   ═══════════════════════════════════════ */
:root {
  --void:           #000000;
  --light:          #FFFFFF;
  --signal:         #FF007F;
  --cyan:           #00FFFF;
  --gold:           #FFD700;
  --surface-01:     #0A0A0A;
  --surface-02:     #111111;
  --surface-03:     #1A1A1A;
  --border-subtle:  #2A2A2A;
  --border-active:  #FFFFFF;
  --text-primary:   #FFFFFF;
  --text-secondary: #666666;
  --text-disabled:  #333333;
  --glow-white:  0 0 12px rgba(255,255,255,0.6);
  --glow-signal: 0 0 20px rgba(255,0,127,0.7);
  --glow-cyan:   0 0 20px rgba(0,255,255,0.7);
  --glow-gold:   0 0 16px rgba(255,215,0,0.6);
  --space-01: 4px; --space-02: 8px; --space-03: 16px; --space-04: 24px;
  --space-05: 32px; --space-06: 48px; --space-07: 64px; --space-08: 96px;
  --type-display: clamp(4rem, 10vw, 12rem);
  --type-hero:    clamp(2rem, 5vw, 5rem);
  --type-title:   2rem;
  --type-label:   0.875rem;
  --type-meta:    0.75rem;
  --type-note:    0.875rem;
  /* TEMPLATE.html compat */
  --bk:#000;--cy:#00FFFF;--pk:#FF007F;--wh:#FFF;--gd:#FFD700;
}

/* ═══════════════════════════════════════
   GLOBAL RESETS
   ═══════════════════════════════════════ */
*{margin:0;padding:0;box-sizing:border-box;border-radius:0 !important}
html,body{width:100vw;height:100vh;overflow:hidden;background:var(--void);font-family:'Space Mono','Consolas',monospace;-webkit-font-smoothing:antialiased}
body.audience-mode{cursor:none}
html:has(body.answers-mode),body.answers-mode{overflow:auto!important;height:auto!important}

/* ═══════════════════════════════════════
   SLIDE BASE (from TEMPLATE.html)
   ═══════════════════════════════════════ */
.S{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--bk);opacity:0;pointer-events:none;will-change:transform,opacity;overflow:visible}
.S.on{opacity:1;pointer-events:all}

/* TRANSITIONS */
.S.t-slam{animation:slam .18s cubic-bezier(.2,1,.3,1) both}
.S.t-breath{animation:breath .8s ease-out both}
.S.t-punch{animation:punch .3s cubic-bezier(.2,1,.3,1) both}
.S.t-fade{animation:fadeIn .5s ease both}
.S.t-shake{animation:shakeIn .4s ease both}
@keyframes slam{0%{opacity:0;transform:scale(1.15)}100%{opacity:1;transform:scale(1)}}
@keyframes breath{0%{opacity:0;transform:scale(.97)}100%{opacity:1;transform:scale(1)}}
@keyframes punch{0%{opacity:0;transform:scale(.85)}60%{opacity:1;transform:scale(1.03)}100%{transform:scale(1)}}
@keyframes fadeIn{0%{opacity:0}100%{opacity:1}}
@keyframes shakeIn{0%{opacity:0;transform:translateX(-8px)}20%{transform:translateX(6px)}40%{transform:translateX(-4px)}60%{transform:translateX(2px)}80%{transform:translateX(-1px)}100%{opacity:1;transform:translateX(0)}}

/* TYPOGRAPHY */
.D{font-family:'Anton','Impact',sans-serif;text-transform:uppercase;text-align:center;line-height:1.05;letter-spacing:.04em}
.M{font-family:'Space Mono','Consolas',monospace;text-transform:uppercase;text-align:center;line-height:1.5;letter-spacing:.02em}

/* HALATION */
.hw{color:var(--wh);text-shadow:0 0 10px rgba(255,255,255,.9),0 0 30px rgba(255,255,255,.5),0 0 60px rgba(255,255,255,.2),0 0 100px rgba(255,255,255,.08)}
.hc{color:var(--cy);text-shadow:0 0 10px rgba(0,255,255,.9),0 0 30px rgba(0,255,255,.5),0 0 60px rgba(0,255,255,.2),0 0 100px rgba(0,255,255,.08)}
.hp{color:var(--pk);text-shadow:0 0 10px rgba(255,0,127,.9),0 0 30px rgba(255,0,127,.5),0 0 60px rgba(255,0,127,.2),0 0 100px rgba(255,0,127,.08)}
.hg{color:var(--gd);text-shadow:0 0 10px rgba(255,215,0,.9),0 0 30px rgba(255,215,0,.5),0 0 60px rgba(255,215,0,.2),0 0 100px rgba(255,215,0,.08)}
.hs{color:var(--wh);text-shadow:0 0 8px rgba(255,255,255,.6),0 0 20px rgba(255,255,255,.3)}

/* NEON BORDERS */
.nb{position:absolute;pointer-events:none}
.nb-pk{inset:24px;border:2px solid var(--pk);box-shadow:0 0 8px rgba(255,0,127,.8),0 0 20px rgba(255,0,127,.5),0 0 40px rgba(255,0,127,.25),inset 0 0 8px rgba(255,0,127,.3),inset 0 0 20px rgba(255,0,127,.1)}
.nb-cy{inset:24px;border:2px solid var(--cy);box-shadow:0 0 8px rgba(0,255,255,.8),0 0 20px rgba(0,255,255,.5),0 0 40px rgba(0,255,255,.25),inset 0 0 8px rgba(0,255,255,.3),inset 0 0 20px rgba(0,255,255,.1)}
.nb-wh{inset:24px;border:1px solid rgba(255,255,255,.5);box-shadow:0 0 4px rgba(255,255,255,.2)}
.nb-gd{inset:24px;border:2px solid var(--gd);box-shadow:0 0 8px rgba(255,215,0,.8),0 0 20px rgba(255,215,0,.5),0 0 40px rgba(255,215,0,.25),inset 0 0 8px rgba(255,215,0,.3)}

/* TIMER BORDER */
.tb{position:absolute;inset:22px;pointer-events:none;border:3px solid transparent;opacity:0;transition:opacity .2s;z-index:2}
.tb.active{opacity:1}
.tb.active~.nb,.S:has(.tb.active) .nb{opacity:0!important;transition:opacity .15s}
.tb.pk{background:conic-gradient(from 0deg,var(--pk) var(--tp,100%),rgba(255,0,127,.15) var(--tp,100%)) border-box;-webkit-mask:linear-gradient(#fff 0 0) padding-box,linear-gradient(#fff 0 0);-webkit-mask-composite:xor;mask-composite:exclude;box-shadow:0 0 20px rgba(255,0,127,.8),0 0 40px rgba(255,0,127,.3)}
.tb.cy{background:conic-gradient(from 0deg,var(--cy) var(--tp,100%),rgba(0,255,255,.15) var(--tp,100%)) border-box;-webkit-mask:linear-gradient(#fff 0 0) padding-box,linear-gradient(#fff 0 0);-webkit-mask-composite:xor;mask-composite:exclude;box-shadow:0 0 20px rgba(0,255,255,.8),0 0 40px rgba(0,255,255,.3)}
.tb.dead{animation:tbDie .5s ease-out both}
.tb.dead~.nb,.S:has(.tb.dead) .nb{opacity:0!important}
@keyframes tbDie{0%{opacity:1;box-shadow:0 0 30px rgba(255,0,127,1)}100%{opacity:0;box-shadow:none}}

/* SCOREBOARD BUG */
#sbug{position:fixed;bottom:0;left:0;right:0;height:48px;display:flex;justify-content:center;align-items:center;gap:40px;font-family:'Space Mono',monospace;font-size:14px;letter-spacing:.08em;text-transform:uppercase;z-index:90;opacity:0;transition:opacity .3s;pointer-events:none;background:linear-gradient(transparent,rgba(0,0,0,.8))}
#sbug.on{opacity:1}
#sbug .team{display:flex;align-items:center;gap:10px}
#sbug .lbl{color:rgba(255,255,255,.4);font-size:11px}
#sbug .sc-cy{color:var(--cy);text-shadow:0 0 8px rgba(0,255,255,.6);font-size:18px;font-weight:700;min-width:30px;text-align:center}
#sbug .sc-pk{color:var(--pk);text-shadow:0 0 8px rgba(255,0,127,.6);font-size:18px;font-weight:700;min-width:30px;text-align:center}
#sbug .vs{color:rgba(255,255,255,.2);font-size:10px}

/* MISC */
.srcbar{position:absolute;bottom:40px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.9);padding:14px 40px;font-family:'Space Mono',monospace;font-size:clamp(18px,2.5vw,32px);color:rgba(255,255,255,.5);text-transform:uppercase;letter-spacing:.06em}
.rule{width:50%;height:1px;background:rgba(255,255,255,.3);margin:12px auto}
.ans-list{font-family:'Space Mono',monospace;text-align:center;line-height:2;padding:3% 8%;width:100%;overflow-y:auto;max-height:80vh}
.ans-list div{color:var(--wh);text-shadow:0 0 6px rgba(255,255,255,.3);font-size:clamp(12px,1.8vw,20px)}
.ans-list .bonus{color:var(--gd);text-shadow:0 0 6px rgba(255,215,0,.4)}
@keyframes pulse{0%,100%{opacity:.8;filter:brightness(1)}50%{opacity:1;filter:brightness(1.3)}}
@keyframes rain{0%,100%{transform:scale(1)}50%{transform:scale(1.03)}}
@keyframes crateGlow{0%,100%{box-shadow:0 0 40px rgba(255,0,127,.4),0 0 80px rgba(255,0,127,.2)}50%{box-shadow:0 0 60px rgba(255,0,127,.7),0 0 120px rgba(255,0,127,.4)}}
@keyframes crateFloat{0%{transform:translateY(-120vh) rotate(-5deg)}60%{transform:translateY(0) rotate(2deg)}75%{transform:translateY(-3vh) rotate(-1deg)}90%{transform:translateY(1vh) rotate(.5deg)}100%{transform:translateY(0) rotate(0)}}
@keyframes crateLidOpen{0%{transform-origin:left center;transform:perspective(800px) rotateY(0)}100%{transform-origin:left center;transform:perspective(800px) rotateY(-110deg)}}
@keyframes crateGlowReveal{0%{opacity:0;transform:scale(.9)}100%{opacity:1;transform:scale(1)}}
.S:not(.on) .crate,.S:not(.on) .crate-lid,.S:not(.on) .crate-interior,.S:not(.on) .crate-L{animation-play-state:paused!important}

/* PARTICLE CANVAS */
#particles{position:fixed;inset:0;pointer-events:none;z-index:80}

/* CRATE DROP */
.crate-container{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:3}
.crate{width:clamp(180px,20vw,300px);height:clamp(120px,14vw,200px);position:relative;animation:crateFloat 1.2s cubic-bezier(.22,.68,.36,1) both}
.crate-body{width:100%;height:100%;background:#0a0a0a;border:2px solid rgba(255,0,127,.6);position:relative;animation:crateGlow 2s ease-in-out infinite 1.4s}
.crate-lid{width:100%;height:20px;background:#0a0a0a;border:2px solid rgba(255,0,127,.6);border-bottom:none;position:absolute;top:-20px;left:0;animation:crateLidOpen .6s ease-out 1.8s both}
.crate-interior{position:absolute;inset:3px;background:var(--pk);opacity:0;animation:crateGlowReveal .4s ease-out 2s both}
.crate-L{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-family:'Anton',sans-serif;font-size:clamp(48px,8vw,80px);color:#0a0a0a;opacity:0;animation:crateGlowReveal .3s ease 2.2s both}

/* BLOOM PULSE */
@keyframes bloomPulse{0%,100%{box-shadow:var(--glow-signal)}50%{box-shadow:0 0 30px rgba(255,0,127,1)}}

/* REVEAL TRANSITION */
.answer{filter:blur(12px);opacity:0.3;transition:filter 0.3s ease,opacity 0.3s ease}
.answer.revealed{filter:blur(0);opacity:1}

/* ═══════════════════════════════════════
   OPERATOR VIEW
   ═══════════════════════════════════════ */
.operator-grid{display:grid;grid-template-columns:220px 1fr 280px;grid-template-rows:1fr auto;width:100vw;height:100vh;background:var(--void);overflow:hidden}

/* Section Nav */
.section-nav{grid-column:1;grid-row:1/3;background:var(--surface-01);border-right:1px solid var(--border-subtle);overflow-y:auto;padding:var(--space-03) 0}
.section-nav-item{display:flex;justify-content:space-between;align-items:center;padding:var(--space-02) var(--space-03);cursor:pointer;border-left:2px solid var(--border-subtle);font-family:'Space Mono',monospace;font-size:var(--type-meta);color:var(--text-secondary);text-transform:uppercase;letter-spacing:.05em;transition:background .1s}
.section-nav-item:hover{background:var(--surface-03)}
.section-nav-item.active{border-left-color:var(--light);color:var(--text-primary);box-shadow:inset 3px 0 8px rgba(255,255,255,0.15)}
.section-nav-count{color:var(--text-disabled);font-size:var(--type-meta)}

/* Main Panel */
.operator-main{grid-column:2;grid-row:1;padding:var(--space-04);display:flex;flex-direction:column;gap:var(--space-03);overflow:hidden}

/* Slide Cards */
.slide-card{border:1px solid var(--border-active);box-shadow:var(--glow-white);background:var(--surface-01);padding:var(--space-04);position:relative;flex:1;display:flex;flex-direction:column;overflow:hidden;min-height:0}
.slide-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--space-03);flex-shrink:0}
.slide-card-type{font-family:'Space Mono',monospace;font-size:var(--type-meta);color:var(--text-secondary);text-transform:uppercase;letter-spacing:.08em}
.slide-card-counter{font-family:'Space Mono',monospace;font-size:var(--type-meta);color:var(--text-secondary)}
.slide-card-content{flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;overflow:hidden}
.slide-card-primary{font-family:'Anton',sans-serif;font-size:var(--type-title);color:var(--text-primary);text-transform:uppercase;text-align:center;line-height:1.1;margin-bottom:var(--space-02)}
.slide-card-answer{font-family:'Space Mono',monospace;font-size:var(--type-label);color:var(--text-secondary);text-align:center;margin-top:var(--space-02)}
.slide-card-source{font-family:'Space Mono',monospace;font-size:var(--type-meta);color:var(--text-disabled);text-align:center;margin-top:var(--space-01)}
.slide-card-notes{font-family:'Space Mono',monospace;font-size:var(--type-note);color:var(--text-secondary);margin-top:auto;padding-top:var(--space-03);border-top:1px solid var(--border-subtle)}

/* Next slide preview */
.slide-card-next{opacity:0.5;border:none;box-shadow:none;background:var(--surface-02);flex:0 0 120px}
.slide-card-next-label{font-family:'Space Mono',monospace;font-size:var(--type-meta);color:var(--text-secondary);text-transform:uppercase;letter-spacing:.08em;margin-bottom:var(--space-02)}

/* Reveal Badge */
.reveal-badge{font-family:'Space Mono',monospace;font-size:10px;letter-spacing:.1em;padding:4px 10px;text-transform:uppercase}
.reveal-badge.hidden{background:var(--surface-03);color:var(--text-secondary)}
.reveal-badge.revealed{background:var(--signal);color:var(--void);box-shadow:var(--glow-signal)}

/* Right Panel */
.operator-right{grid-column:3;grid-row:1/3;background:var(--surface-01);border-left:1px solid var(--border-subtle);padding:var(--space-03);display:flex;flex-direction:column;gap:var(--space-03);overflow-y:auto}

/* Score Display */
.score-panel{display:flex;gap:var(--space-03)}
.score-team{flex:1;background:var(--surface-02);padding:var(--space-03);text-align:center}
.score-label{font-family:'Space Mono',monospace;font-size:var(--type-label);color:var(--text-secondary);text-transform:uppercase;letter-spacing:.08em;margin-bottom:var(--space-02)}
.score-value{font-family:'Space Mono',monospace;font-size:var(--type-title);font-weight:700;min-height:2.5rem}
.score-value.cyan{color:var(--cyan);text-shadow:var(--glow-cyan)}
.score-value.pink{color:var(--signal);text-shadow:var(--glow-signal)}
.score-buttons{display:flex;gap:var(--space-02);margin-top:var(--space-02);justify-content:center}
.score-btn{width:44px;height:44px;border:1px solid var(--border-subtle);background:transparent;color:var(--text-primary);font-family:'Space Mono',monospace;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.score-btn:hover{background:var(--surface-03)}

/* Timer Display */
.timer-display{background:var(--surface-02);padding:var(--space-03)}
.timer-label{font-family:'Space Mono',monospace;font-size:var(--type-meta);color:var(--text-secondary);text-transform:uppercase;letter-spacing:.08em;margin-bottom:var(--space-02)}
.timer-bar-track{height:4px;background:var(--surface-03);position:relative;margin-bottom:var(--space-02)}
.timer-bar-fill{height:100%;background:var(--light);transition:width 0.1s linear}
.timer-bar-fill.danger{background:var(--signal);box-shadow:var(--glow-signal)}
.timer-bar-fill.critical{background:var(--signal);animation:bloomPulse .5s ease-in-out infinite}
.timer-time{font-family:'Space Mono',monospace;font-size:var(--type-label);color:var(--text-primary);text-align:center}
.timer-buttons{display:flex;gap:var(--space-02);margin-top:var(--space-02)}
.timer-btn{flex:1;height:36px;border:1px solid var(--border-subtle);background:transparent;color:var(--text-primary);font-family:'Space Mono',monospace;font-size:var(--type-meta);cursor:pointer;text-transform:uppercase;letter-spacing:.05em}
.timer-btn:hover{background:var(--surface-03)}
.auto-toggle{display:flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--border-subtle);background:transparent;color:var(--text-secondary);font-family:'Space Mono',monospace;font-size:10px;letter-spacing:.06em;text-transform:uppercase;cursor:pointer;width:100%}
.auto-toggle:hover{background:var(--surface-03)}
.auto-toggle.on{border-color:var(--cyan);color:var(--cyan);text-shadow:0 0 6px rgba(0,255,255,.5)}
.auto-toggle-dot{width:8px;height:8px;border:1px solid var(--text-disabled);flex-shrink:0}
.auto-toggle.on .auto-toggle-dot{background:var(--cyan);border-color:var(--cyan);box-shadow:0 0 6px rgba(0,255,255,.7)}

/* Shortcut Overlay */
.shortcut-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:500;display:flex;align-items:center;justify-content:center}
.shortcut-grid{display:grid;grid-template-columns:auto auto;gap:var(--space-02) var(--space-05);align-items:center}
.shortcut-key{font-family:'Space Mono',monospace;font-size:var(--type-label);background:var(--surface-02);border:1px solid var(--border-subtle);padding:6px 12px;color:var(--text-primary);text-align:center;min-width:60px}
.shortcut-action{font-family:'Space Mono',monospace;font-size:var(--type-meta);color:var(--text-secondary);text-transform:uppercase}

/* Reward Tier Overlay */
.reward-overlay{position:fixed;inset:0;background:rgba(0,0,0,.97);z-index:400;display:flex;align-items:center;justify-content:center;animation:slam .18s cubic-bezier(.2,1,.3,1) both}

/* Quick Access Buttons */
.quick-btn{display:flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--border-subtle);background:transparent;color:var(--text-secondary);font-family:'Space Mono',monospace;font-size:10px;letter-spacing:.06em;text-transform:uppercase;cursor:pointer;white-space:nowrap}
.quick-btn:hover{background:var(--surface-03);color:var(--text-primary)}
.quick-btn-row{display:flex;gap:var(--space-02);flex-wrap:wrap}

/* Connection Signal */
.conn-signal{display:flex;align-items:center;gap:6px;font-family:'Space Mono',monospace;font-size:10px;letter-spacing:.08em;text-transform:uppercase}
.conn-dot{width:8px;height:8px;display:inline-block}
.conn-dot.on{background:var(--cyan);box-shadow:0 0 6px rgba(0,255,255,.8)}
.conn-dot.off{background:var(--signal);box-shadow:0 0 6px rgba(255,0,127,.8);animation:bloomPulse 1s ease-in-out infinite}

/* Bottom Bar */
.operator-bottom{grid-column:2;grid-row:2;background:var(--surface-01);border-top:1px solid var(--border-subtle);padding:var(--space-02) var(--space-04);display:flex;align-items:center;justify-content:space-between}
.receipt-counter{font-family:'Space Mono',monospace;font-size:var(--type-meta);color:var(--text-secondary);text-transform:uppercase;letter-spacing:.05em}

/* Launcher View */
.launcher-view{position:fixed;inset:0;background:var(--void);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:var(--space-06)}
.launcher-title{font-family:'Anton','Impact',sans-serif;text-transform:uppercase;font-size:clamp(48px,12vw,120px);letter-spacing:.06em;line-height:1;text-align:center}
.launcher-grid{display:grid;grid-template-columns:1fr 1fr;gap:var(--space-03);width:100%;max-width:400px;padding:0 var(--space-04)}
.launcher-btn{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;padding:var(--space-04) var(--space-03);border:1px solid var(--border-subtle);background:transparent;color:var(--text-primary);font-family:'Space Mono',monospace;font-size:var(--type-label);letter-spacing:.08em;text-transform:uppercase;cursor:pointer;text-decoration:none;transition:border-color .15s,box-shadow .15s}
.launcher-btn:hover{border-color:var(--signal);box-shadow:0 0 12px rgba(255,0,127,.4)}
.launcher-btn-sub{font-size:10px;color:var(--text-disabled);letter-spacing:.05em}
.launcher-meta{font-family:'Space Mono',monospace;font-size:10px;color:var(--text-disabled);letter-spacing:.08em;text-transform:uppercase;text-align:center}

/* Login */
.login-input::placeholder{color:var(--text-disabled);letter-spacing:.08em;text-transform:uppercase}
.login-input:-webkit-autofill{-webkit-box-shadow:0 0 0 30px var(--surface-02) inset!important;-webkit-text-fill-color:var(--text-primary)!important}

/* Red Flag Queue */
.rf-panel{background:var(--surface-02);border:1px solid var(--border-subtle);padding:var(--space-02) var(--space-03)}
.rf-header{display:flex;align-items:center;justify-content:space-between;cursor:pointer}
.rf-title{font-family:'Space Mono',monospace;font-size:var(--type-meta);color:var(--signal);text-transform:uppercase;letter-spacing:.08em}
.rf-count{font-family:'Space Mono',monospace;font-size:var(--type-meta);color:var(--text-disabled)}
.rf-body{margin-top:var(--space-02)}
.rf-textarea{width:100%;min-height:120px;background:var(--surface-01);border:1px solid var(--border-subtle);color:var(--text-primary);font-family:'Space Mono',monospace;font-size:11px;padding:var(--space-02);resize:vertical;outline:none;box-sizing:border-box}
.rf-textarea:focus{border-color:var(--signal);box-shadow:0 0 8px rgba(255,0,127,.2)}
.rf-btns{display:flex;gap:var(--space-02);margin-top:var(--space-02)}
.rf-btn{flex:1;padding:6px;border:1px solid var(--border-subtle);background:transparent;color:var(--text-secondary);font-family:'Space Mono',monospace;font-size:10px;letter-spacing:.06em;text-transform:uppercase;cursor:pointer}
.rf-btn:hover{background:var(--surface-03)}
.rf-btn.save{border-color:var(--signal);color:var(--signal)}

/* ═══ SETLIST EDITOR ═══ */
.setlist-overlay{position:fixed;inset:0;background:rgba(0,0,0,.97);z-index:500;display:flex;flex-direction:column;overflow:hidden}
.setlist-header{flex-shrink:0;display:flex;align-items:center;justify-content:space-between;padding:var(--space-03) var(--space-04);border-bottom:1px solid var(--border-subtle)}
.setlist-title{font-family:'Anton',sans-serif;font-size:var(--type-title);color:var(--text-primary);text-transform:uppercase}
.setlist-close{background:transparent;border:1px solid var(--border-subtle);color:var(--text-secondary);font-family:'Space Mono',monospace;font-size:10px;padding:6px 16px;cursor:pointer;text-transform:uppercase;letter-spacing:.08em}
.setlist-close:hover{background:var(--surface-03)}
.setlist-body{flex:1;overflow-y:auto;padding:var(--space-04)}
.setlist-section{margin-bottom:var(--space-04)}
.setlist-section-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:var(--space-02);padding-bottom:var(--space-01);border-bottom:1px solid var(--border-subtle)}
.setlist-section-name{font-family:'Space Mono',monospace;font-size:var(--type-meta);color:var(--signal);text-transform:uppercase;letter-spacing:.12em}
.setlist-section-count{font-family:'Space Mono',monospace;font-size:var(--type-meta);color:var(--text-disabled)}
.setlist-slide{display:flex;align-items:center;gap:var(--space-02);padding:var(--space-02) var(--space-03);border:1px solid var(--border-subtle);background:var(--surface-01);margin-bottom:2px;cursor:grab;user-select:none;min-height:36px}
.setlist-slide:active{cursor:grabbing}
.setlist-slide.sortable-ghost{opacity:.3;border-color:var(--signal)}
.setlist-slide.sortable-chosen{border-color:var(--border-active);box-shadow:var(--glow-white)}
.setlist-slide-grip{color:var(--text-disabled);font-size:14px;flex-shrink:0;width:20px;text-align:center}
.setlist-slide-type{font-family:'Space Mono',monospace;font-size:9px;color:var(--text-disabled);text-transform:uppercase;letter-spacing:.08em;min-width:80px;flex-shrink:0}
.setlist-slide-text{font-family:'Space Mono',monospace;font-size:11px;color:var(--text-primary);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.setlist-slide-answer{font-family:'Space Mono',monospace;font-size:9px;color:var(--text-secondary);flex-shrink:0;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.setlist-slide-actions{display:flex;gap:4px;flex-shrink:0}
.setlist-btn{background:transparent;border:1px solid var(--border-subtle);color:var(--text-secondary);font-family:'Space Mono',monospace;font-size:9px;padding:3px 8px;cursor:pointer;text-transform:uppercase;letter-spacing:.06em}
.setlist-btn:hover{background:var(--surface-03)}
.setlist-btn.accent{border-color:var(--signal);color:var(--signal)}
.setlist-btn.accent:hover{background:rgba(255,0,127,.1)}
.setlist-alt-popup{position:absolute;right:0;top:100%;background:var(--surface-02);border:1px solid var(--border-subtle);z-index:10;min-width:200px;max-width:320px;box-shadow:0 4px 16px rgba(0,0,0,.8)}
.setlist-alt-item{padding:var(--space-02) var(--space-03);cursor:pointer;font-family:'Space Mono',monospace;font-size:10px;color:var(--text-secondary);border-bottom:1px solid var(--border-subtle)}
.setlist-alt-item:hover{background:var(--surface-03);color:var(--text-primary)}
.setlist-alt-item:last-child{border-bottom:none}
.setlist-footer{flex-shrink:0;display:flex;align-items:center;gap:var(--space-03);padding:var(--space-03) var(--space-04);border-top:1px solid var(--border-subtle);background:var(--surface-01);flex-wrap:wrap}
.setlist-input{background:var(--surface-02);border:1px solid var(--border-subtle);color:var(--text-primary);font-family:'Space Mono',monospace;font-size:11px;padding:6px 12px;outline:none;min-width:180px}
.setlist-input:focus{border-color:var(--signal)}
.setlist-import-area{padding:var(--space-03) var(--space-04);border-top:1px solid var(--border-subtle);background:var(--surface-02)}
.setlist-import-textarea{width:100%;min-height:80px;background:var(--surface-01);border:1px solid var(--border-subtle);color:var(--text-primary);font-family:'Space Mono',monospace;font-size:10px;padding:var(--space-02);resize:vertical;outline:none;box-sizing:border-box}
.setlist-import-textarea:focus{border-color:var(--signal)}
.setlist-import-error{font-family:'Space Mono',monospace;font-size:10px;color:var(--signal);margin-top:var(--space-02)}
.setlist-load-list{position:absolute;bottom:100%;left:0;background:var(--surface-02);border:1px solid var(--border-subtle);z-index:10;min-width:300px;max-height:350px;overflow-y:auto;box-shadow:0 -4px 16px rgba(0,0,0,.8)}
.setlist-load-item{display:flex;align-items:center;gap:6px;padding:var(--space-02) var(--space-03);cursor:pointer;font-family:'Space Mono',monospace;font-size:10px;color:var(--text-secondary);border-bottom:1px solid var(--border-subtle)}
.setlist-load-item:hover{background:var(--surface-03);color:var(--text-primary)}
.setlist-load-item.active{border-left:2px solid var(--signal)}
.setlist-load-del{color:var(--text-disabled);cursor:pointer;padding:2px 6px;font-size:12px;background:none;border:none;flex-shrink:0}
.setlist-load-del:hover{color:var(--signal)}
.setlist-load-section-head{font-family:'Space Mono',monospace;font-size:8px;color:var(--text-disabled);text-transform:uppercase;letter-spacing:.12em;padding:6px var(--space-03) 4px;border-bottom:1px solid var(--border-subtle);background:var(--surface-01);position:sticky;top:0;z-index:1}
.setlist-load-badge{font-family:'Space Mono',monospace;font-size:8px;padding:1px 4px;letter-spacing:.06em;flex-shrink:0;border:1px solid var(--cyan);color:var(--cyan)}
.setlist-load-badge.default{border-color:var(--gold);color:var(--gold)}
.setlist-lock-badge{font-family:'Space Mono',monospace;font-size:10px;color:var(--signal);text-transform:uppercase;letter-spacing:.1em;border:1px solid var(--signal);padding:4px 12px;box-shadow:var(--glow-signal)}
.setlist-live-btn{background:transparent;border:1px solid var(--signal);color:var(--signal);font-family:'Space Mono',monospace;font-size:10px;padding:6px 16px;cursor:pointer;text-transform:uppercase;letter-spacing:.08em;margin-left:auto}
.setlist-live-btn:hover{background:rgba(255,0,127,.1)}

/* ═══ MOBILE OPERATOR REMOTE ═══ */
@media(max-width:768px),(max-height:500px){
  .mob-shell{position:fixed;inset:0;background:var(--void);display:flex;flex-direction:column;overflow:hidden;font-family:'Space Mono',monospace}
  .mob-top{flex-shrink:0;height:48px;display:flex;align-items:center;justify-content:space-between;padding:0 var(--space-03);border-bottom:1px solid var(--border-subtle);background:var(--surface-01)}
  .mob-top-section{font-size:10px;color:var(--signal);letter-spacing:.12em;text-transform:uppercase;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:50%}
  .mob-top-counter{font-size:10px;color:var(--text-secondary);letter-spacing:.08em}
  .mob-scroll{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:var(--space-03)}
  .mob-card{background:var(--surface-01);border:1px solid var(--border-active);padding:var(--space-03);margin-bottom:var(--space-03)}
  .mob-card-type{font-size:10px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.08em;margin-bottom:var(--space-02)}
  .mob-card-title{font-family:'Anton',sans-serif;font-size:clamp(24px,6vw,36px);color:var(--text-primary);text-transform:uppercase;text-align:center;line-height:1.1}
  .mob-card-answer{font-size:var(--type-label);color:var(--text-secondary);text-align:center;margin-top:var(--space-02)}
  .mob-card-notes{font-size:10px;color:var(--text-secondary);margin-top:var(--space-02);padding-top:var(--space-02);border-top:1px solid var(--border-subtle)}
  .mob-reveal{display:inline-block;font-size:10px;letter-spacing:.1em;padding:4px 10px;text-transform:uppercase;cursor:pointer;margin-top:var(--space-02)}
  .mob-reveal.hidden{background:var(--surface-03);color:var(--text-secondary)}
  .mob-reveal.revealed{background:var(--signal);color:var(--void);box-shadow:var(--glow-signal)}
  .mob-next{background:var(--surface-02);padding:var(--space-03);opacity:.6;margin-bottom:var(--space-03)}
  .mob-next-label{font-size:10px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.08em;margin-bottom:4px}
  .mob-next-text{font-family:'Anton',sans-serif;font-size:var(--type-label);color:var(--text-secondary);text-transform:uppercase}
  .mob-section-chips{display:flex;gap:6px;overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:var(--space-02);margin-bottom:var(--space-03);scrollbar-width:none}
  .mob-section-chips::-webkit-scrollbar{display:none}
  .mob-chip{flex-shrink:0;padding:6px 12px;font-size:10px;letter-spacing:.06em;text-transform:uppercase;border:1px solid var(--border-subtle);background:transparent;color:var(--text-secondary);cursor:pointer;white-space:nowrap}
  .mob-chip.active{border-color:var(--light);color:var(--text-primary);box-shadow:inset 0 0 8px rgba(255,255,255,.1)}
  .mob-scores{display:flex;gap:var(--space-02);margin-bottom:var(--space-03)}
  .mob-score-team{flex:1;background:var(--surface-02);padding:var(--space-02);text-align:center}
  .mob-score-label{font-size:10px;letter-spacing:.08em;text-transform:uppercase;margin-bottom:4px}
  .mob-score-val{font-family:'Space Mono',monospace;font-size:var(--type-title);font-weight:700}
  .mob-score-btns{display:flex;gap:4px;justify-content:center;margin-top:6px}
  .mob-score-btn{width:40px;height:40px;border:1px solid var(--border-subtle);background:transparent;color:var(--text-primary);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center}
  .mob-score-btn:active{background:var(--surface-03)}
  .mob-bottom{flex-shrink:0;height:60px;display:flex;border-top:1px solid var(--border-subtle);background:var(--surface-01)}
  .mob-nav-btn{flex:1;display:flex;align-items:center;justify-content:center;gap:8px;background:transparent;border:none;color:var(--text-primary);font-family:'Space Mono',monospace;font-size:var(--type-label);letter-spacing:.08em;text-transform:uppercase;cursor:pointer;-webkit-tap-highlight-color:transparent}
  .mob-nav-btn:active{background:var(--surface-03)}
  .mob-nav-btn.primary{background:var(--signal);color:var(--void);font-weight:700}
  .mob-nav-divider{width:1px;background:var(--border-subtle)}
  .mob-signout{font-size:10px;color:var(--text-disabled);letter-spacing:.06em;text-transform:uppercase;background:transparent;border:1px solid var(--border-subtle);padding:4px 12px;cursor:pointer;margin-top:var(--space-03)}
}

/* Audience View wrapper */
.audience-view{position:fixed;inset:0;background:var(--void)}
.audience-view .slide-wrapper{position:absolute;inset:0}

/* ═══════════════════════════════════════
   MOBILE RESPONSIVE — PORTRAIT
   ═══════════════════════════════════════ */
@media(max-width:600px){
  /* Neon borders: tighter inset on small screens */
  .nb-pk,.nb-cy,.nb-wh,.nb-gd{inset:12px}
  .tb{inset:10px}
  /* Source bar */
  .srcbar{bottom:20px;padding:10px 20px;font-size:clamp(11px,3vw,18px)}
  /* Scoreboard */
  #sbug{height:36px;gap:20px;font-size:11px}
  #sbug .sc-cy,#sbug .sc-pk{font-size:14px;min-width:24px}
  #sbug .lbl{font-size:9px}
  #sbug .vs{font-size:8px}
  /* Launcher refinements */
  .launcher-view{gap:var(--space-05);padding:0 var(--space-03)}
  .launcher-title{font-size:clamp(40px,14vw,100px)}
  .launcher-grid{gap:var(--space-02);padding:0 var(--space-03)}
  .launcher-btn{padding:var(--space-03) var(--space-02);font-size:clamp(11px,3vw,14px)}
  .launcher-btn-sub{font-size:clamp(8px,2.2vw,10px)}
  /* Answers view */
  .answers-wrap{padding:20px 16px}
  .ans-h1{font-size:24px}
}

/* ═══════════════════════════════════════
   MOBILE RESPONSIVE — LANDSCAPE
   ═══════════════════════════════════════ */
@media(max-height:500px) and (orientation:landscape){
  /* Neon borders: tight inset for short viewports */
  .nb-pk,.nb-cy,.nb-wh,.nb-gd{inset:10px}
  .tb{inset:8px}
  /* Source bar */
  .srcbar{bottom:14px;padding:6px 16px;font-size:clamp(10px,2vh,16px)}
  /* Scoreboard */
  #sbug{height:28px;gap:16px;font-size:10px}
  #sbug .sc-cy,#sbug .sc-pk{font-size:12px}
  #sbug .lbl{font-size:8px}
  /* Answer reveal text */
  .answer{bottom:40px!important;font-size:clamp(10px,2vh,16px)!important}
  /* Launcher in landscape */
  .launcher-view{flex-direction:row;gap:var(--space-05);padding:var(--space-03)}
  .launcher-title{font-size:clamp(28px,8vh,72px)}
  .launcher-grid{max-width:320px;gap:var(--space-02)}
  .launcher-btn{padding:var(--space-02) var(--space-02);font-size:clamp(10px,1.8vh,13px)}
  .launcher-btn-sub{font-size:clamp(7px,1.4vh,10px)}
}

/* ═══════════════════════════════════════
   VOTE VIEW — MOBILE
   ═══════════════════════════════════════ */
@media(max-width:600px){
  [data-testid="vote-view"]{padding:var(--space-03)!important}
}

/* Answers View */
.answers-wrap{background:#000;color:#fff;font-family:'Space Mono',monospace;padding:40px;max-width:900px;margin:0 auto;min-height:100vh}
.ans-h1{color:#FF007F;font-size:32px;letter-spacing:.1em;margin-bottom:8px;font-family:'Anton',sans-serif}
.ans-sub{color:rgba(255,255,255,.3);font-size:11px;letter-spacing:.15em;margin-bottom:48px;text-transform:uppercase}
.ans-sec{margin-bottom:48px}
.ans-rt{color:#00FFFF;font-size:18px;letter-spacing:.08em;margin-bottom:4px;font-weight:700}
.ans-rd{color:rgba(255,255,255,.3);font-size:11px;margin-bottom:16px;letter-spacing:.06em}
.ans-tbl{width:100%;border-collapse:collapse;margin-bottom:8px}
.ans-th{text-align:left;color:rgba(255,255,255,.3);font-size:10px;letter-spacing:.1em;text-transform:uppercase;padding:6px 8px;border-bottom:1px solid rgba(255,255,255,.1)}
.ans-td{padding:8px;border-bottom:1px solid rgba(255,255,255,.06);font-size:13px;vertical-align:top;color:#fff}
.ans-pk{color:#FF007F}
.ans-cy{color:#00FFFF;letter-spacing:.04em}
.ans-gd{color:#FFD700}
.ans-dim{color:rgba(255,255,255,.4)}
.ans-bold{font-weight:700}
.ans-grid2{display:grid;grid-template-columns:1fr 1fr;gap:4px 24px}
.ans-pair{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.06);font-size:13px}
@media print{.answers-wrap{background:#fff!important;color:#000!important}.ans-h1{color:#FF007F!important}.ans-rt{color:#0088aa!important}.ans-cy{color:#0088aa!important}.ans-pk{color:#FF007F!important}.ans-td,.ans-th{border-bottom-color:rgba(0,0,0,.1)!important}}
</style>
</head>
<body>
<div id="root"></div>
<canvas id="particles"></canvas>
<script type="text/babel">
// ═══════════════════════════════════════
// FIREBASE INIT
// ═══════════════════════════════════════
let fb=null,fbdb=null,fbauth=null;
try{
  fb=firebase.initializeApp({
    apiKey:"AIzaSyC8ECLUReNM4JSkhRRuwTELmGTLWNVSrIE",
    authDomain:"lineconic-live.firebaseapp.com",
    databaseURL:"https://lineconic-live-default-rtdb.europe-west1.firebasedatabase.app",
    projectId:"lineconic-live",
    storageBucket:"lineconic-live.firebasestorage.app",
    messagingSenderId:"890189018310",
    appId:"1:890189018310:web:7cc55ce3f3833b14c6d3c7"
  });
  fbdb=firebase.database();
  fbauth=firebase.auth();
}catch(e){console.warn('Firebase offline',e)}

// ═══════════════════════════════════════
// SOUND ENGINE (from TEMPLATE.html)
// ═══════════════════════════════════════
let actx=null;
function initAudio(){if(!actx)try{actx=new(window.AudioContext||window.webkitAudioContext)()}catch(e){}}
function tone(freq,dur,type,vol,ramp){
  if(!actx)return;
  const o=actx.createOscillator(),g=actx.createGain();
  o.type=type||'sine';o.frequency.setValueAtTime(freq,actx.currentTime);
  g.gain.setValueAtTime(0,actx.currentTime);g.gain.linearRampToValueAtTime(vol||.08,actx.currentTime+.02);
  if(ramp)o.frequency.linearRampToValueAtTime(ramp,actx.currentTime+dur);
  g.gain.exponentialRampToValueAtTime(.001,actx.currentTime+dur);
  o.connect(g);g.connect(actx.destination);o.start();o.stop(actx.currentTime+dur+.05);
}
let shep=null;
function startShepard(){
  if(!actx||shep)return;
  const L=[];
  [110,220,440,880].forEach(b=>{const o=actx.createOscillator(),g=actx.createGain();o.type='sine';o.frequency.value=b;g.gain.value=.012;o.connect(g);g.connect(actx.destination);o.start();L.push({o,g,b,f:b})});
  const id=setInterval(()=>{L.forEach(l=>{l.f*=1.003;if(l.f>1600){l.f=l.b;l.o.frequency.value=l.b;l.g.gain.setValueAtTime(0,actx.currentTime);l.g.gain.linearRampToValueAtTime(.012,actx.currentTime+.5)}else{l.o.frequency.value=l.f}})},50);
  shep={L,id};
}
function stopShepard(){if(!shep)return;clearInterval(shep.id);shep.L.forEach(l=>{l.g.gain.exponentialRampToValueAtTime(.001,actx.currentTime+.3);l.o.stop(actx.currentTime+.4)});shep=null}
function sfx(type,muted){
  if(muted)return;initAudio();
  const isQ=type==="source_q"||type==="acronym_q"||type==="hotseat_prompt";
  if(!isQ)stopShepard();
  switch(type){
    case"source_q":case"acronym_q":case"hotseat_prompt":if(!shep)startShepard();break;
    case"source_a":case"acronym_a":tone(180,.25,"triangle",.15);setTimeout(()=>tone(240,.3,"triangle",.12),80);break;
    case"bonus_marker":tone(600,.1,"square",.06);setTimeout(()=>tone(800,.1,"square",.06),100);setTimeout(()=>tone(1000,.15,"square",.08),200);break;
    case"doa_verdict_dead":tone(80,.8,"sawtooth",.1);break;
    case"doa_verdict_alive":tone(523,.12,"sine",.08);setTimeout(()=>tone(659,.12,"sine",.08),80);setTimeout(()=>tone(784,.2,"sine",.1),160);break;
    case"receipt_rain":tone(100,.6,"sawtooth",.12);setTimeout(()=>tone(150,.5,"sawtooth",.1),200);break;
    case"crate_drop":tone(60,.8,"sine",.06,30);setTimeout(()=>{tone(200,.2,"triangle",.08);tone(300,.15,"triangle",.06)},1200);setTimeout(()=>tone(523,.4,"sine",.1),1900);break;
    case"score":tone(440,.15,"sine",.06);setTimeout(()=>tone(554,.15,"sine",.06),120);setTimeout(()=>tone(659,.3,"sine",.08),240);break;
    case"round_title":tone(200,.5,"sine",.05,400);break;
    case"verdict":tone(60,1.5,"sawtooth",.08);break;
    case"last_line":tone(330,.3,"sine",.06);setTimeout(()=>tone(440,.3,"sine",.06),200);setTimeout(()=>tone(554,.5,"sine",.08),400);break;
    case"fluency_line":tone(350,.12,"sine",.05);break;
    case"doa_ref":tone(150,.3,"triangle",.07);break;
    case"doa_vote":tone(200,.2,"sine",.05);setTimeout(()=>tone(250,.2,"sine",.05),150);break;
  }
}

// ═══════════════════════════════════════
// PARTICLE SYSTEM (from TEMPLATE.html)
// ═══════════════════════════════════════
const cvs=document.getElementById('particles');
const pctx=cvs.getContext('2d');
let parts=[],partAnim=null;
function resizeCvs(){cvs.width=window.innerWidth;cvs.height=window.innerHeight}
window.addEventListener('resize',resizeCvs);resizeCvs();
function spawnReceipts(count){parts=[];for(let i=0;i<count;i++){parts.push({x:Math.random()*cvs.width,y:-Math.random()*cvs.height*2,w:4+Math.random()*10,h:16+Math.random()*30,vy:1.5+Math.random()*3,vx:(Math.random()-.5)*1.2,rot:Math.random()*Math.PI*2,vr:(Math.random()-.5)*.06,a:.5+Math.random()*.5})}}
function spawnFlutter(count){for(let i=0;i<count;i++){parts.push({x:Math.random()*cvs.width,y:-Math.random()*cvs.height*.5,w:3+Math.random()*6,h:12+Math.random()*20,vy:.3+Math.random()*.8,vx:(Math.random()-.5)*2,rot:Math.random()*Math.PI*2,vr:(Math.random()-.5)*.04,a:.3+Math.random()*.5})}}
function tickParticles(){pctx.clearRect(0,0,cvs.width,cvs.height);let alive=false;parts.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.rot+=p.vr;if(p.gravity){p.vy+=p.gravity;p.vx*=p.drag}if(p.y>cvs.height+60||p.y<-cvs.height*2.5){p.a*=.95}if(p.a<.01)return;alive=true;pctx.save();pctx.translate(p.x,p.y);pctx.rotate(p.rot);pctx.fillStyle=p.color||'rgba(255,0,127,'+p.a+')';pctx.globalAlpha=p.a;pctx.fillRect(-p.w/2,-p.h/2,p.w,p.h);pctx.restore()});if(alive)partAnim=requestAnimationFrame(tickParticles);else{partAnim=null;parts=[];pctx.clearRect(0,0,cvs.width,cvs.height)}}
function startParticles(type){if(partAnim){cancelAnimationFrame(partAnim);partAnim=null}parts=[];pctx.clearRect(0,0,cvs.width,cvs.height);if(type==='rain'){spawnReceipts(500);partAnim=requestAnimationFrame(tickParticles)}else if(type==='flutter'){spawnFlutter(80);partAnim=requestAnimationFrame(tickParticles)}}
function stopParticles(){if(partAnim){cancelAnimationFrame(partAnim);partAnim=null}parts=[];pctx.clearRect(0,0,cvs.width,cvs.height)}

// ═══════════════════════════════════════
// TIMER SYSTEM
// ═══════════════════════════════════════
let timerState={running:false,paused:false,remaining:0,total:0,rafId:null,elRef:null,onEnd:null};
function startTimerSystem(sec,el,onEnd){
  stopTimerSystem();
  timerState={running:true,paused:false,remaining:sec*1000,total:sec*1000,rafId:null,elRef:el,onEnd:onEnd||null};
  if(el){el.classList.add('active');el.classList.remove('dead')}
  resumeTimerSystem();
}
function resumeTimerSystem(){
  if(!timerState.running||timerState.remaining<=0)return;
  timerState.paused=false;
  const t0=performance.now(),startR=timerState.remaining;
  (function tick(now){
    if(timerState.paused||!timerState.running)return;
    timerState.remaining=Math.max(0,startR-(now-t0));
    const pct=timerState.remaining/timerState.total;
    if(timerState.elRef)timerState.elRef.style.setProperty('--tp',(pct*100)+'%');
    if(timerState.remaining<=0){if(timerState.elRef){timerState.elRef.classList.add('dead');timerState.elRef.classList.remove('active')}tone(200,.3,'square',.1);setTimeout(()=>tone(150,.3,'square',.08),150);timerState.running=false;if(timerState.onEnd)setTimeout(timerState.onEnd,800);return}
    timerState.rafId=requestAnimationFrame(tick);
  })(performance.now());
}
function pauseTimerSystem(){if(timerState.rafId){cancelAnimationFrame(timerState.rafId);timerState.rafId=null}timerState.paused=true}
function stopTimerSystem(){if(timerState.rafId){cancelAnimationFrame(timerState.rafId);timerState.rafId=null}if(timerState.elRef){timerState.elRef.classList.remove('active','dead')}timerState={running:false,paused:false,remaining:0,total:0,rafId:null,elRef:null}}

// ═══════════════════════════════════════
// DOA VOTING (from TEMPLATE.html)
// ═══════════════════════════════════════
let votes={dead:0,alive:0},fbVoteRef=null,voteListeners=[];
function onVotesChange(fn){voteListeners.push(fn);return()=>{voteListeners=voteListeners.filter(f=>f!==fn)}}
function notifyVotes(){voteListeners.forEach(fn=>fn({...votes}))}
function pushTopic(name){
  if(fbdb){fbdb.ref('currentTopic').set(name||null);const key=(name||'').replace(/[^a-zA-Z0-9]/g,'_');if(fbVoteRef){fbVoteRef.off();fbVoteRef=null}if(name){fbVoteRef=fbdb.ref('votes/'+key);fbVoteRef.on('value',snap=>{const v=snap.val()||{};votes.dead=v.dead||0;votes.alive=v.alive||0;notifyVotes()})}}
}
function castVote(v,topic){
  if(fbdb&&topic){const key=topic.replace(/[^a-zA-Z0-9]/g,'_');fbdb.ref('votes/'+key+'/'+v).transaction(c=>(c||0)+1)}else{votes[v]++;notifyVotes()}
}
function resetVotes(topic){
  votes={dead:0,alive:0};notifyVotes();
  if(fbdb&&topic){const key=topic.replace(/[^a-zA-Z0-9]/g,'_');fbdb.ref('votes/'+key).set({dead:0,alive:0})}
}

// ═══════════════════════════════════════
// QR CODE (from TEMPLATE.html)
// ═══════════════════════════════════════
function drawQR(canvas){
  if(!canvas)return;
  const x=canvas.getContext('2d');
  const url='https://lineconic.live/vote';
  const qr=qrcode(0,'L');
  qr.addData(url);
  qr.make();
  const sz=qr.getModuleCount();
  const cvSz=canvas.width;
  const px=Math.floor(cvSz/sz);
  const off=Math.floor((cvSz-sz*px)/2);
  x.fillStyle='#fff';x.fillRect(0,0,cvSz,cvSz);
  x.fillStyle='#000';
  for(let r=0;r<sz;r++)for(let cl=0;cl<sz;cl++){
    if(qr.isDark(r,cl))x.fillRect(off+cl*px,off+r*px,px,px);
  }
}

// ═══════════════════════════════════════
// STATE (inlined from lib/state.js)
// ═══════════════════════════════════════
const initialState={show:null,currentSlide:0,scores:[0,0],revealState:{},showScoreboard:false,showShortcuts:false,showHostPanel:false,muted:true,receipts:0,redFlags:[],liveMode:false,showSetlistEditor:false};
function flattenSlides(show,redFlags){
  if(!show)return[];
  var flat=show.sections.flatMap(function(s){return s.slides});
  if(!redFlags||!redFlags.length)return flat;
  var fi=flat.findIndex(function(s){return s.type==='fishbowl'});
  if(fi<0)return flat;
  var rfSlides=redFlags.map(function(text,i){return{id:'rf-'+i,type:'red_flag',content:{primary:text,secondary:(i+1)+' / '+redFlags.length},reveal_state:'hidden',team:'neutral',timer_seconds:null,host_notes:null,points:null}});
  var result=flat.slice();
  result.splice(fi+1,0,...rfSlides);
  return result;
}
function redFlagSectionOffset(show,redFlags){
  if(!show||!redFlags||!redFlags.length)return{sectionIdx:-1,offset:0};
  var count=0;
  for(var i=0;i<show.sections.length;i++){
    for(var j=0;j<show.sections[i].slides.length;j++){
      if(show.sections[i].slides[j].type==='fishbowl')return{sectionIdx:i,offset:redFlags.length};
      count++;
    }
  }
  return{sectionIdx:-1,offset:0};
}
function slideToSection(show,flatIndex,redFlags){
  var rfo=redFlagSectionOffset(show,redFlags);
  var count=0;
  for(var i=0;i<show.sections.length;i++){
    count+=show.sections[i].slides.length;
    if(i===rfo.sectionIdx)count+=rfo.offset;
    if(flatIndex<count)return i;
  }
  return show.sections.length-1;
}
function getSectionStartIndex(show,sectionIndex,redFlags){
  var rfo=redFlagSectionOffset(show,redFlags);
  var count=0;
  for(var i=0;i<sectionIndex;i++){
    count+=show.sections[i].slides.length;
    if(i===rfo.sectionIdx)count+=rfo.offset;
  }
  return count;
}
function reducer(state,action){
  const flat=state.show?flattenSlides(state.show,state.redFlags):[];const maxSlide=Math.max(0,flat.length-1);
  switch(action.type){
    case'NEXT_SLIDE':return{...state,currentSlide:Math.min(state.currentSlide+1,maxSlide)};
    case'PREV_SLIDE':return{...state,currentSlide:Math.max(state.currentSlide-1,0)};
    case'JUMP_SECTION':{const idx=getSectionStartIndex(state.show,action.payload,state.redFlags);return{...state,currentSlide:Math.min(idx,maxSlide)}}
    case'GO_TO_SLIDE':return{...state,currentSlide:Math.max(0,Math.min(action.payload,maxSlide))};
    case'SCORE_CYAN':{const[cy,pk]=state.scores;return{...state,scores:[Math.max(0,cy+action.payload),pk]}}
    case'SCORE_PINK':{const[cy,pk]=state.scores;return{...state,scores:[cy,Math.max(0,pk+action.payload)]}}
    case'TOGGLE_REVEAL':{const slide=flat[state.currentSlide];if(!slide)return state;const cur=state.revealState[slide.id]||'hidden';return{...state,revealState:{...state.revealState,[slide.id]:cur==='hidden'?'revealed':'hidden'}}}
    case'TOGGLE_SCOREBOARD':return{...state,showScoreboard:!state.showScoreboard};
    case'TOGGLE_SHORTCUTS':return{...state,showShortcuts:!state.showShortcuts};
    case'TOGGLE_MUTE':return{...state,muted:!state.muted};
    case'CLOSE_OVERLAYS':return{...state,showShortcuts:false,showHostPanel:false,showSetlistEditor:false};
    case'INCREMENT_RECEIPTS':return{...state,receipts:state.receipts+1};
    case'SET_SCORES':return{...state,scores:action.payload};
    case'SET_REVEAL_STATE':return{...state,revealState:action.payload};
    case'SET_SCOREBOARD':return{...state,showScoreboard:action.payload};
    case'SET_MUTED':return{...state,muted:action.payload};
    case'SET_SHOW':return{...state,show:action.payload,currentSlide:0};
    case'SET_RED_FLAGS':{var newFlags=action.payload.slice(0,20);if(action.fromSync)return{...state,redFlags:newFlags};var oldFlat=flattenSlides(state.show,state.redFlags);var newFlat=flattenSlides(state.show,newFlags);var curSlide=oldFlat[state.currentSlide];var ci=state.currentSlide;if(curSlide){var ni=newFlat.findIndex(function(s){return s.id===curSlide.id});if(ni>=0)ci=ni}return{...state,redFlags:newFlags,currentSlide:ci}}
    case'TOGGLE_SETLIST_EDITOR':if(state.liveMode)return state;return{...state,showSetlistEditor:!state.showSetlistEditor};
    case'SET_LIVE_MODE':return{...state,liveMode:true,showSetlistEditor:false};
    case'REORDER_SLIDES':{if(state.liveMode)return state;var rsi=action.payload.sectionIndex;var ns=state.show.sections.map(function(sec,i){return i!==rsi?sec:{...sec,slides:action.payload.newOrder}});return{...state,show:{...state.show,sections:ns}}}
    case'SWAP_SLIDE':{if(state.liveMode)return state;var swSi=action.payload.sectionIndex;var swSli=action.payload.slideIndex;var repl=action.payload.newSlide;var swSecs=state.show.sections.map(function(sec,i){if(i!==swSi)return sec;var swSlides=sec.slides.map(function(slide,j){if(j!==swSli)return slide;var alts=(repl.alternates||[]).filter(function(a){return a.id!==slide.id});var orig={id:slide.id,type:slide.type,content:slide.content};if(slide.alternates)orig.alternates=slide.alternates;alts.push(orig);return{...repl,alternates:alts}});return{...sec,slides:swSlides}});return{...state,show:{...state.show,sections:swSecs}}}
    case'IMPORT_SHOW':return{...state,show:action.payload,currentSlide:0,liveMode:false,showSetlistEditor:false};
    default:return state;
  }
}

// ═══════════════════════════════════════
// RENDERER HELPERS (inlined from lib/renderers.js)
// ═══════════════════════════════════════
function qSz(t){const l=(t||'').length;if(l<=4)return'clamp(72px,22vw,280px)';if(l<=8)return'clamp(56px,16vw,220px)';if(l<=14)return'clamp(36px,10vw,170px)';if(l<=20)return'clamp(28px,7vw,130px)';return'clamp(22px,5vw,90px)'}
function aSz(t){const l=(t||'').length;if(l<=8)return'clamp(40px,11vw,160px)';if(l<=14)return'clamp(32px,8vw,130px)';if(l<=20)return'clamp(28px,6.5vw,100px)';if(l<=28)return'clamp(22px,5vw,80px)';if(l<=38)return'clamp(18px,3.8vw,62px)';if(l<=50)return'clamp(16px,3vw,48px)';return'clamp(14px,2.5vw,36px)'}
function tx(type){switch(type){case'source_q':case'acronym_q':case'fluency_line':case'bonus_marker':return't-slam';case'source_a':case'acronym_a':case'fluency_source':case'doa_verdict_dead':case'doa_verdict_alive':return't-punch';case'round_title':case'verdict':case'intermission':case'last_line':case'endcard':return't-breath';case'receipt_rain':return't-shake';case'crate_drop':return't-fade';default:return't-fade'}}
function esc(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
function nwStyle(){return{whiteSpace:'nowrap',maxWidth:'calc(100% - 32px)',padding:'2vh 16px',overflow:'visible'}}

// ═══════════════════════════════════════
// REACT COMPONENTS — SLIDE RENDERERS
// ═══════════════════════════════════════
const {useState,useEffect,useReducer,useRef,useCallback,useMemo}=React;

function AttractSlide({slide}){
  return <div className="D hp" style={{fontSize:'clamp(120px,40vw,350px)',animation:'pulse 2s ease-in-out infinite'}}>{slide.content.primary||'L'}</div>;
}
function FishbowlSlide({slide}){
  return <><div className="nb nb-pk"></div><div className="D hp" style={{fontSize:'clamp(28px,6vw,64px)',marginBottom:16,padding:'0 8%'}}>{slide.content.primary}</div><div className="M hs" style={{fontSize:'clamp(12px,2.5vw,22px)',padding:'0 8%'}}>{slide.content.secondary||''}</div></>;
}
function RedFlagSlide({slide}){
  return <><div className="nb nb-pk"></div><div className="D hp" style={{fontSize:'clamp(28px,6vw,64px)',color:'var(--signal)',textShadow:'var(--glow-signal)',marginBottom:16,padding:'0 8%'}}>{slide.content.primary}</div><div className="M hs" style={{fontSize:'clamp(12px,2.5vw,22px)',color:'var(--text-secondary)',padding:'0 8%'}}>{slide.content.secondary||''}</div></>;
}
function RoundTitleSlide({slide}){
  return <><div className="D hw" style={{fontSize:'clamp(50px,10vw,150px)',marginBottom:10}}>{slide.content.primary||''}</div>{slide.content.secondary?<div className="D hw" style={{fontSize:aSz(slide.content.secondary),...nwStyle()}}>{slide.content.secondary}</div>:null}</>;
}
function TierTitleSlide({slide}){
  const lines=(slide.content.secondary||'').split('|').map(l=>l.trim());
  return <><div className="nb nb-wh"></div><div className="D hs" style={{fontSize:'clamp(28px,4vw,56px)',marginBottom:16,padding:'0 5%'}}>{slide.content.primary||''}</div><div className="rule"></div><div className="M" style={{color:'rgba(255,255,255,.5)',fontSize:'clamp(18px,2.2vw,28px)',lineHeight:'2.2'}}>{lines.map((l,i)=><div key={i}>{l}</div>)}</div></>;
}
function BonusMarkerSlide({slide}){
  return <><div className="nb nb-gd"></div><div className="D hg" style={{fontSize:'clamp(36px,8vw,120px)',padding:'0 8%'}}>{slide.content.primary||''}</div></>;
}
function SourceQSlide({slide,revealed}){
  return <><div className="nb nb-pk"></div><div className="tb pk"></div><div className="D hw" style={{fontSize:aSz(slide.content.primary),...nwStyle()}}>{slide.content.primary||''}</div>{slide.content.answer?<div className={'answer'+(revealed?' revealed':'')} style={{position:'absolute',bottom:60,left:'50%',transform:'translateX(-50%)',fontFamily:"'Space Mono',monospace",fontSize:'clamp(14px,2vw,24px)',color:'var(--wh)',textTransform:'uppercase',letterSpacing:'.06em'}}>{slide.content.answer}</div>:null}</>;
}
function SourceASlide({slide}){
  return <><div className="nb nb-wh"></div><div className="D hw" style={{fontSize:aSz(slide.content.primary),...nwStyle()}}>{slide.content.primary||''}</div></>;
}
function AcronymQSlide({slide,revealed}){
  return <><div className="nb nb-cy"></div><div className="tb cy"></div><div className="D hw" style={{fontSize:qSz(slide.content.primary),letterSpacing:'.08em',...nwStyle()}}>{slide.content.primary||''}</div>{slide.content.source?<div className="srcbar">{slide.content.source}</div>:null}{slide.content.answer?<div className={'answer'+(revealed?' revealed':'')} style={{position:'absolute',bottom:80,left:'50%',transform:'translateX(-50%)',fontFamily:"'Space Mono',monospace",fontSize:'clamp(14px,2vw,24px)',color:'var(--wh)',textTransform:'uppercase',letterSpacing:'.06em',textAlign:'center',maxWidth:'80%'}}>{slide.content.answer}</div>:null}</>;
}
function AcronymASlide({slide}){
  return <><div className="nb nb-pk"></div><div className="D hw" style={{fontSize:aSz(slide.content.primary),...nwStyle()}}>{slide.content.primary||''}</div>{slide.content.secondary?<div className="srcbar">{slide.content.secondary}</div>:null}</>;
}
function FluencyLineSlide({slide}){
  return <><div className="nb nb-wh"></div><div className="D hw" style={{fontSize:aSz(slide.content.primary),...nwStyle()}}>{slide.content.primary||''}</div></>;
}
function FluencySourceSlide({slide}){
  return <div className="D hw" style={{fontSize:aSz(slide.content.primary),...nwStyle()}}>{slide.content.primary||''}</div>;
}
function ScoreSlide({slide}){
  return <><div className="D hw" style={{fontSize:'clamp(28px,4vw,56px)'}}>{slide.content.primary||''}</div>{slide.content.secondary?<div className="M hs" style={{fontSize:'clamp(12px,1.5vw,18px)',marginTop:14}}>{slide.content.secondary}</div>:null}</>;
}
function IntermissionSlide({slide}){
  const qrRef=useRef(null);
  useEffect(()=>{if(qrRef.current)drawQR(qrRef.current)},[]);
  return <><div className="D hw" style={{fontSize:'clamp(40px,7vw,100px)',marginBottom:20}}>{slide.content.primary||''}</div><div className="M hs" style={{fontSize:'clamp(14px,2vw,24px)',marginBottom:30}}>{slide.content.secondary||''}</div><canvas ref={qrRef} width={400} height={400} style={{imageRendering:'pixelated',width:'clamp(200px,28vw,320px)',height:'clamp(200px,28vw,320px)',border:'5px solid rgba(255,255,255,.3)'}}></canvas><a href="https://lineconic.live/vote" target="_blank" rel="noopener" className="M" style={{color:'rgba(255,255,255,.5)',fontSize:'clamp(16px,2.5vw,28px)',marginTop:16,letterSpacing:'.1em',textDecoration:'none'}}>LINECONIC.LIVE/VOTE</a></>;
}
function DoaVoteSlide({slide}){
  const[liveVotes,setLiveVotes]=useState({dead:votes.dead,alive:votes.alive});
  useEffect(()=>{setLiveVotes({dead:votes.dead,alive:votes.alive});return onVotesChange(setLiveVotes)},[]);
  const total=liveVotes.dead+liveVotes.alive;const dp=total>0?Math.round(liveVotes.dead/total*100):50;const ap=total>0?100-dp:50;
  return <><div className="nb nb-wh"></div><div className="D hw" style={{fontSize:aSz(slide.content.primary),...nwStyle(),marginBottom:30}}>{slide.content.primary||''}</div><div style={{width:'70%',maxWidth:600}}><div style={{display:'flex',justifyContent:'space-between',marginBottom:8}}><span className="M" style={{color:'var(--pk)',fontSize:'clamp(12px,1.5vw,18px)',letterSpacing:'.1em'}}>DEAD</span><span className="M" style={{color:'var(--cy)',fontSize:'clamp(12px,1.5vw,18px)',letterSpacing:'.1em'}}>ALIVE</span></div><div style={{width:'100%',height:'clamp(24px,4vh,40px)',background:'rgba(255,255,255,.05)',border:'1px solid rgba(255,255,255,.1)',position:'relative',overflow:'hidden'}}><div style={{position:'absolute',left:0,top:0,bottom:0,width:dp+'%',background:'linear-gradient(90deg,var(--pk),rgba(255,0,127,.3))',transition:'width .6s cubic-bezier(.4,0,.2,1)'}}></div><div style={{position:'absolute',right:0,top:0,bottom:0,width:ap+'%',background:'linear-gradient(270deg,var(--cy),rgba(0,255,255,.3))',transition:'width .6s cubic-bezier(.4,0,.2,1)'}}></div></div><div style={{display:'flex',justifyContent:'space-between',marginTop:8}}><span className="M" style={{color:'var(--pk)',fontSize:'clamp(18px,3vw,36px)'}}>{dp}%</span><span className="M" style={{color:'var(--cy)',fontSize:'clamp(18px,3vw,36px)'}}>{ap}%</span></div></div></>;
}
function WarningSlide({slide}){return <div className="D hw" style={{fontSize:'clamp(60px,12vw,180px)'}}>{slide.content.primary||''}</div>}
function BlackoutSlide(){return null}
function TransitionBeatSlide(){return null}
function DoaRefSlide({slide}){return <><div className="nb nb-wh"></div><div className="D hw" style={{fontSize:aSz(slide.content.primary),...nwStyle()}}>{slide.content.primary||''}</div></>}
function DoaVerdictDeadSlide({slide}){return <><div className="nb nb-pk"></div><div className="D hp" style={{fontSize:'clamp(80px,18vw,260px)'}}>{slide.content.primary||''}</div></>}
function DoaVerdictAliveSlide({slide}){return <><div className="nb nb-cy"></div><div className="D hc" style={{fontSize:'clamp(80px,18vw,260px)'}}>{slide.content.primary||''}</div></>}
function HotseatRulesSlide({slide}){
  const lines=(slide.content.secondary||'').split('|').map(l=>l.trim());
  return <><div className="nb nb-wh"></div><div className="D hw" style={{fontSize:'clamp(24px,3.5vw,48px)',marginBottom:12}}>{slide.content.primary||''}</div><div className="rule"></div><div className="M hs" style={{fontSize:'clamp(14px,1.8vw,22px)',lineHeight:2}}>{lines.map((l,i)=><div key={i}>{l}</div>)}</div></>;
}
function HotseatPromptSlide({slide}){return <><div className="nb nb-cy"></div><div className="tb cy"></div><div className="D hc" style={{fontSize:aSz(slide.content.primary),...nwStyle()}}>{slide.content.primary||''}</div>{slide.content.source?<div className="srcbar">{slide.content.source}</div>:null}</>}
function VerdictSlide({slide}){return <div className="D hw" style={{fontSize:'clamp(60px,12vw,180px)'}}>{slide.content.primary||''}</div>}
function SentenceSlide({slide}){
  const lines=(slide.content.secondary||'').split('|').map(l=>l.trim());
  return <><div className="D hw" style={{fontSize:'clamp(36px,6vw,80px)',marginBottom:20}}>{slide.content.primary||''}</div><div className="M hs" style={{fontSize:'clamp(14px,2vw,24px)'}}>{lines.map((l,i)=><div key={i} style={{marginBottom:8}}>{l}</div>)}</div></>;
}
function ReceiptRainSlide({slide}){return <div className="D hp" style={{fontSize:'clamp(50px,12vw,160px)',animation:'rain .8s ease-in-out infinite',zIndex:4,position:'relative'}}>{slide.content.primary||''}</div>}
function CrateDropSlide(){return <div className="crate-container"><div className="crate"><div className="crate-lid"></div><div className="crate-body"><div className="crate-interior"><div className="crate-L">L</div></div></div></div></div>}
function LastLineSlide({slide}){return <><div className="nb nb-wh"></div><div className="D hw" style={{fontSize:aSz(slide.content.primary),...nwStyle()}}>{slide.content.primary||''}</div></>}
function EndcardSlide({slide}){return <><div className="D hp" style={{fontSize:'clamp(100px,30vw,300px)',marginBottom:12}}>{slide.content.primary||'L'}</div><div className="M hs" style={{fontSize:'clamp(12px,1.5vw,18px)'}}>{slide.content.secondary||''}</div></>}
function AnswerSheetSlide({slide}){
  const items=(slide.content.secondary||'').split('|').map(a=>a.trim());
  return <><div className="nb nb-wh"></div><div className="D hw" style={{fontSize:'clamp(20px,3vw,36px)',marginBottom:12,paddingTop:'3%'}}>{slide.content.primary||''}</div><div className="rule"></div><div className="ans-list">{items.map((a,i)=><div key={i} className={a.includes('[')?'bonus':''}>{a}</div>)}</div></>;
}

// ═══════════════════════════════════════
// SLIDE RENDERER DISPATCHER
// ═══════════════════════════════════════
const RENDERERS={
  attract:AttractSlide,fishbowl:FishbowlSlide,red_flag:RedFlagSlide,round_title:RoundTitleSlide,tier_title:TierTitleSlide,
  bonus_marker:BonusMarkerSlide,source_q:SourceQSlide,source_a:SourceASlide,acronym_q:AcronymQSlide,
  acronym_a:AcronymASlide,fluency_line:FluencyLineSlide,fluency_source:FluencySourceSlide,
  score:ScoreSlide,intermission:IntermissionSlide,doa_vote:DoaVoteSlide,warning:WarningSlide,
  blackout:BlackoutSlide,transition_beat:TransitionBeatSlide,doa_ref:DoaRefSlide,
  doa_verdict_dead:DoaVerdictDeadSlide,doa_verdict_alive:DoaVerdictAliveSlide,
  hotseat_rules:HotseatRulesSlide,hotseat_prompt:HotseatPromptSlide,verdict:VerdictSlide,
  sentence:SentenceSlide,receipt_rain:ReceiptRainSlide,crate_drop:CrateDropSlide,
  last_line:LastLineSlide,endcard:EndcardSlide,answer_sheet:AnswerSheetSlide,
};

function SlideRenderer({slide,revealed}){
  const Comp=RENDERERS[slide.type];
  if(!Comp)return null;
  return <Comp slide={slide} revealed={revealed}/>;
}

// ═══════════════════════════════════════
// LAUNCHER VIEW (Homepage)
// ═══════════════════════════════════════
function LauncherView({showName}){
  return(
    <div className="launcher-view">
      <div>
        <a href="/" style={{textDecoration:'none'}}><div className="launcher-title hp">LINECONIC</div>
        <div className="launcher-title hs" style={{fontSize:'clamp(16px,4vw,32px)',letterSpacing:'.2em',marginTop:8}}>LIVE</div></a>
      </div>
      <div className="launcher-grid">
        <a className="launcher-btn" href="/operator"><span>OPERATOR</span><span className="launcher-btn-sub">HOST CONTROLS</span></a>
        <a className="launcher-btn" href="/audience" target="_blank" rel="noopener"><span>AUDIENCE</span><span className="launcher-btn-sub">SCREEN OUTPUT</span></a>
        <a className="launcher-btn" href="/answers" target="_blank" rel="noopener"><span>ANSWERS</span><span className="launcher-btn-sub">ANSWER SHEET</span></a>
        <a className="launcher-btn" href="/vote" target="_blank" rel="noopener"><span>VOTE</span><span className="launcher-btn-sub">AUDIENCE PHONES</span></a>
        <a className="launcher-btn" href="/builder" style={{gridColumn:'1 / -1'}}><span>BUILDER</span><span className="launcher-btn-sub">DECK GENERATOR</span></a>
      </div>
    </div>
  );
}

// ═══════════════════════════════════════
// AUDIENCE VIEW (The Monolith)
// ═══════════════════════════════════════
function AudienceView({state,dispatch,slideRef:externalSlideRef,rewardTier}){
  const flat=useMemo(()=>flattenSlides(state.show,state.redFlags),[state.show,state.redFlags]);
  const slide=flat[state.currentSlide];
  const prevSlideRef=useRef(null);
  const localSlideRef=useRef(null);
  // Use external ref if provided (for timer sync), otherwise local
  const slideRef=externalSlideRef||localSlideRef;

  useEffect(()=>{
    if(!slide)return;
    const el=slideRef.current;
    if(!el)return;
    // Reset timer on slide change
    stopTimerSystem();
    // Remove old transition classes
    el.className='S on';
    void el.offsetHeight;
    el.classList.add(tx(slide.type));
    // Sound
    sfx(slide.type,state.muted);
    // Particles
    stopParticles();
    if(slide.type==='receipt_rain')startParticles('rain');
    if(slide.type==='last_line'||slide.type==='endcard')startParticles('flutter');
    // DOA — reset local vote counts on new vote slide (topic push handled by operator in App)
    if(slide.type==='doa_vote'){votes={dead:0,alive:0};notifyVotes()}
    prevSlideRef.current=state.currentSlide;
  },[state.currentSlide,slide]);

  if(!slide)return <div className="audience-view"><div className="S on"><div className="D hp" style={{fontSize:'clamp(60px,12vw,180px)'}}>LOADING...</div></div></div>;

  const revealed=(state.revealState[slide.id]||'hidden')==='revealed';

  return (
    <div className="audience-view">
      <div ref={slideRef} className="S on">
        <SlideRenderer slide={slide} revealed={revealed}/>
      </div>
      <div id="sbug" className={state.showScoreboard?'on':''}>
        <div className="team"><span className="lbl">CYAN</span><span className="sc-cy">{state.scores[0]}</span></div>
        <div className="vs">VS</div>
        <div className="team"><span className="sc-pk">{state.scores[1]}</span><span className="lbl">PINK</span></div>
      </div>
      <RewardTierOverlay tier={rewardTier}/>
    </div>
  );
}

// ═══════════════════════════════════════
// OPERATOR VIEW COMPONENTS
// ═══════════════════════════════════════
function SectionNav({show,currentSlide,dispatch,redFlags}){
  const sectionIdx=slideToSection(show,currentSlide,redFlags);
  const rfo=redFlagSectionOffset(show,redFlags);
  return (
    <div className="section-nav">
      <div style={{padding:'var(--space-03)',color:'var(--signal)',fontFamily:"'Space Mono',monospace",fontSize:11,letterSpacing:'.15em',borderBottom:'1px solid var(--border-subtle)',marginBottom:'var(--space-02)'}}>SECTIONS</div>
      {show.sections.map((sec,i)=>(
        <div key={sec.id} className={'section-nav-item'+(i===sectionIdx?' active':'')} onClick={()=>dispatch({type:'JUMP_SECTION',payload:i})}>
          <span style={{overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',flex:1,marginRight:8}}>{sec.name}</span>
          <span className="section-nav-count">{sec.slides.length+(i===rfo.sectionIdx?rfo.offset:0)}</span>
        </div>
      ))}
    </div>
  );
}

function CurrentSlideCard({slide,slideIndex,totalSlides,revealState,dispatch}){
  const revealed=(revealState[slide.id]||'hidden')==='revealed';
  return (
    <div className="slide-card">
      <div className="slide-card-header">
        <span className="slide-card-type">{slide.type}</span>
        <div style={{display:'flex',alignItems:'center',gap:'var(--space-03)'}}>
          <span className={'reveal-badge '+(revealed?'revealed':'hidden')} onClick={()=>dispatch({type:'TOGGLE_REVEAL'})}>{revealed?'REVEALED':'HIDDEN'}</span>
          <span className="slide-card-counter" data-testid="slide-counter">{slideIndex+1}/{totalSlides}</span>
        </div>
      </div>
      <div className="slide-card-content">
        <div className="slide-card-primary">{slide.content.primary||''}</div>
        {slide.content.answer&&<div className="slide-card-answer">{slide.content.answer}</div>}
        {slide.content.source&&<div className="slide-card-source">{slide.content.source}</div>}
        {slide.content.secondary&&<div style={{fontFamily:"'Space Mono',monospace",fontSize:'var(--type-meta)',color:'var(--text-disabled)',marginTop:'var(--space-02)',textAlign:'center'}}>{slide.content.secondary}</div>}
      </div>
      {slide.host_notes&&<div className="slide-card-notes">// {slide.host_notes}</div>}
    </div>
  );
}

function NextSlideCard({slide}){
  if(!slide)return <div className="slide-card-next"><div className="slide-card-next-label">NEXT</div><div style={{color:'var(--text-disabled)',fontFamily:"'Space Mono',monospace",fontSize:'var(--type-meta)'}}>END OF SHOW</div></div>;
  return (
    <div className="slide-card-next" style={{padding:'var(--space-03)'}}>
      <div className="slide-card-next-label">NEXT</div>
      <div style={{fontFamily:"'Space Mono',monospace",fontSize:'var(--type-meta)',color:'var(--text-secondary)',textTransform:'uppercase'}}>{slide.type}</div>
      <div style={{fontFamily:"'Anton',sans-serif",fontSize:'var(--type-label)',color:'var(--text-secondary)',marginTop:'var(--space-01)',textTransform:'uppercase'}}>{slide.content.primary||''}</div>
    </div>
  );
}

function ScoreDisplay({scores,dispatch}){
  return (
    <div>
      <div style={{fontFamily:"'Space Mono',monospace",fontSize:'var(--type-meta)',color:'var(--text-secondary)',textTransform:'uppercase',letterSpacing:'.08em',marginBottom:'var(--space-02)'}}>SCOREBOARD</div>
      <div className="score-panel">
        <div className="score-team">
          <div className="score-label">CYAN</div>
          <div className="score-value cyan" data-testid="cyan-score">{scores[0]}</div>
          <div className="score-buttons">
            <button className="score-btn" onClick={()=>dispatch({type:'SCORE_CYAN',payload:-1})}>-</button>
            <button className="score-btn" onClick={()=>dispatch({type:'SCORE_CYAN',payload:1})}>+</button>
          </div>
        </div>
        <div className="score-team">
          <div className="score-label">PINK</div>
          <div className="score-value pink" data-testid="pink-score">{scores[1]}</div>
          <div className="score-buttons">
            <button className="score-btn" onClick={()=>dispatch({type:'SCORE_PINK',payload:-1})}>-</button>
            <button className="score-btn" onClick={()=>dispatch({type:'SCORE_PINK',payload:1})}>+</button>
          </div>
        </div>
      </div>
    </div>
  );
}

function TimerDisplay({onTimerAction,autoAdvanceRef,autoTimerDuration,dispatch}){
  const[time,setTime]=useState(30);
  const[running,setRunning]=useState(false);
  const[pct,setPct]=useState(100);
  const[paused,setPaused]=useState(false);
  useEffect(()=>{
    if(!running)return;
    const interval=setInterval(()=>{
      const r=timerState.remaining;const t=timerState.total;
      if(t>0)setPct((r/t)*100);
      setTime(Math.ceil(r/1000));
      setPaused(timerState.paused);
      if(!timerState.running){setRunning(false);setPct(0);setPaused(false)}
    },100);
    return()=>clearInterval(interval);
  },[running]);
  const danger=pct<33;const critical=pct<17;
  function startDuration(sec){
    if(autoTimerDuration)autoTimerDuration.current=sec;
    const onEnd=(autoAdvanceRef&&autoAdvanceRef.current)?function(){dispatch({type:'NEXT_SLIDE'})}:null;
    startTimerSystem(sec,null,onEnd);setRunning(true);setPct(100);if(onTimerAction)onTimerAction('start',sec);
  }
  return (
    <div className="timer-display">
      <div className="timer-label">TIMER</div>
      <div className="timer-bar-track"><div className={'timer-bar-fill'+(danger?' danger':'')+(critical?' critical':'')} style={{width:pct+'%'}}></div></div>
      <div className="timer-time">{running?String(Math.floor(time/60)).padStart(2,'0')+':'+String(time%60).padStart(2,'0'):'--:--'}</div>
      <div className="timer-buttons">
        <button className="timer-btn" onClick={()=>startDuration(10)}>10s</button>
        <button className="timer-btn" onClick={()=>startDuration(15)}>15s</button>
        <button className="timer-btn" onClick={()=>startDuration(30)}>30s</button>
        <button className="timer-btn" onClick={()=>startDuration(60)}>1m</button>
      </div>
      <div className="timer-buttons" style={{marginTop:'var(--space-01)'}}>
        <button className="timer-btn" onClick={()=>{if(timerState.paused){resumeTimerSystem();setPaused(false);if(onTimerAction)onTimerAction('resume')}else{pauseTimerSystem();setPaused(true);if(onTimerAction)onTimerAction('pause')}}}>{paused?'RESUME':'PAUSE'}</button>
        <button className="timer-btn" onClick={()=>{stopTimerSystem();setRunning(false);setPct(100);if(onTimerAction)onTimerAction('stop')}}>STOP</button>
      </div>
    </div>
  );
}

function QuickAccessButtons(){
  const base=window.location.origin;
  const[copied,setCopied]=useState(null);
  function openTab(mode){window.open(base+'/'+mode,'_blank')}
  function copyLink(mode){
    navigator.clipboard.writeText(base+'/'+mode).then(()=>{setCopied(mode);setTimeout(()=>setCopied(null),1500)}).catch(()=>{});
  }
  return(
    <div style={{display:'flex',flexDirection:'column',gap:'var(--space-01)'}}>
      <div style={{fontFamily:"'Space Mono',monospace",fontSize:'var(--type-meta)',color:'var(--text-secondary)',textTransform:'uppercase',letterSpacing:'.08em',marginBottom:2}}>QUICK ACCESS</div>
      <div className="quick-btn-row">
        <button className="quick-btn" onClick={()=>openTab('answers')}>ANSWERS ↗</button>
        <button className="quick-btn" onClick={()=>copyLink('answers')}>{copied==='answers'?'COPIED!':'COPY LINK'}</button>
      </div>
      <div className="quick-btn-row">
        <button className="quick-btn" onClick={()=>openTab('vote')}>VOTE ↗</button>
        <button className="quick-btn" onClick={()=>copyLink('vote')}>{copied==='vote'?'COPIED!':'COPY LINK'}</button>
      </div>
      <div className="quick-btn-row">
        <button className="quick-btn" onClick={()=>openTab('audience')}>AUDIENCE ↗</button>
      </div>
    </div>
  );
}

function ConnectionSignal(){
  const[connected,setConnected]=useState(false);
  useEffect(()=>{
    if(!fbdb)return;
    const ref=fbdb.ref('.info/connected');
    const handler=snap=>{setConnected(!!snap.val())};
    ref.on('value',handler);
    return()=>ref.off('value',handler);
  },[]);
  return(
    <div className="conn-signal">
      <span className={'conn-dot '+(connected?'on':'off')}></span>
      <span style={{color:connected?'var(--cyan)':'var(--signal)'}}>{connected?'CONNECTED':'OFFLINE'}</span>
    </div>
  );
}

function ShortcutOverlay({onClose}){
  const shortcuts=[
    ['SPACE / \u2192','ADVANCE SLIDE'],['←','PREVIOUS SLIDE'],['R','REVEAL / HIDE ANSWER'],
    ['Q / W','CYAN SCORE +/-'],['P / O','PINK SCORE +/-'],['1 \u2013 9','JUMP TO SECTION'],
    ['T','START TIMER'],['A','AUTO-TIMER'],['D','AUTO-ADVANCE'],
    ['C','ADD RECEIPT'],['G','REWARD TIER'],
    ['L','SETLIST EDITOR'],['S','TOGGLE SCOREBOARD'],['M','MUTE / UNMUTE'],['F','FULLSCREEN'],
    ['?','THIS MENU'],['ESC','CLOSE'],
  ];
  return (
    <div className="shortcut-overlay" onClick={onClose}>
      <div className="shortcut-grid">
        {shortcuts.map(([key,action])=><React.Fragment key={key}><div className="shortcut-key">{key}</div><div className="shortcut-action">{action}</div></React.Fragment>)}
      </div>
    </div>
  );
}

function RewardTierOverlay({tier}){
  if(!tier)return null;
  const tiers={cancel:{label:'INSTANT CANCEL',cls:'hp',border:'nb-pk'},grind:{label:'THE GRIND',cls:'hg',border:'nb-gd'},flop:{label:'THE FLOP',cls:'hs',border:'nb-wh'}};
  const t=tiers[tier];if(!t)return null;
  return(
    <div className="reward-overlay">
      <div className={'nb '+t.border}></div>
      <div className={'D '+t.cls} style={{fontSize:'clamp(60px,14vw,200px)'}}>{t.label}</div>
    </div>
  );
}

function AutoToggles({autoTimer,autoAdvance,setAutoTimer,setAutoAdvance,muted,onToggleMute}){
  return(
    <div style={{display:'flex',flexDirection:'column',gap:'var(--space-01)'}}>
      <div style={{fontFamily:"'Space Mono',monospace",fontSize:'var(--type-meta)',color:'var(--text-secondary)',textTransform:'uppercase',letterSpacing:'.08em',marginBottom:2}}>CONTROLS</div>
      <button className={'auto-toggle'+(!muted?' on':'')} onClick={onToggleMute}>
        <span className="auto-toggle-dot"></span>
        <span>{muted?'UNMUTE SFX':'SFX ON'}</span>
        <span style={{marginLeft:'auto',opacity:.5}}>[M]</span>
      </button>
      <button className={'auto-toggle'+(autoTimer?' on':'')} onClick={()=>setAutoTimer(function(v){return!v})}>
        <span className="auto-toggle-dot"></span>
        <span>AUTO-TIMER {autoTimer?'ON':'OFF'}</span>
        <span style={{marginLeft:'auto',opacity:.5}}>[A]</span>
      </button>
      <button className={'auto-toggle'+(autoAdvance?' on':'')} onClick={()=>setAutoAdvance(function(v){return!v})}>
        <span className="auto-toggle-dot"></span>
        <span>AUTO-ADVANCE {autoAdvance?'ON':'OFF'}</span>
        <span style={{marginLeft:'auto',opacity:.5}}>[D]</span>
      </button>
    </div>
  );
}

function RedFlagForm({redFlags,dispatch}){
  const[expanded,setExpanded]=useState(false);
  const[text,setText]=useState(redFlags.join('\n'));
  // Sync textarea when redFlags change externally (e.g. loaded from localStorage)
  useEffect(function(){setText(redFlags.join('\n'))},[redFlags.length]);
  function handleSave(){
    var flags=text.split('\n').map(function(l){return l.trim()}).filter(Boolean).slice(0,20);
    dispatch({type:'SET_RED_FLAGS',payload:flags});
    try{localStorage.setItem('lineconic_redflags',JSON.stringify(flags))}catch(e){}
  }
  function handleClear(){
    setText('');
    dispatch({type:'SET_RED_FLAGS',payload:[]});
    try{localStorage.removeItem('lineconic_redflags')}catch(e){}
  }
  return(
    <div className="rf-panel">
      <div className="rf-header" onClick={function(){setExpanded(!expanded)}}>
        <span className="rf-title">RED FLAGS</span>
        <span className="rf-count">{redFlags.length}/20 {expanded?'▾':'▸'}</span>
      </div>
      {expanded&&<div className="rf-body">
        <textarea className="rf-textarea" value={text} onChange={function(e){setText(e.target.value)}} placeholder="One red flag per line...&#10;e.g. Still uses Internet Explorer&#10;Claps when the plane lands" maxLength={2000}/>
        <div className="rf-btns">
          <button className="rf-btn save" onClick={handleSave}>SAVE</button>
          <button className="rf-btn" onClick={handleClear}>CLEAR</button>
        </div>
      </div>}
    </div>
  );
}



function MobileOperatorLayout({state,dispatch,flat,slide,nextSlide,onTimerAction,autoTimer,autoAdvance,setAutoTimer,setAutoAdvance,autoAdvanceRef,autoTimerDuration}){
  const sectionIdx=slideToSection(state.show,state.currentSlide,state.redFlags);
  const revealed=(state.revealState[slide.id]||'hidden')==='revealed';
  const chipsRef=useRef(null);

  // Auto-scroll active chip into view
  useEffect(function(){
    if(!chipsRef.current)return;
    var active=chipsRef.current.querySelector('.mob-chip.active');
    if(active)active.scrollIntoView({behavior:'smooth',inline:'center',block:'nearest'});
  },[sectionIdx]);

  function navPrev(){stopTimerSystem();if(onTimerAction)onTimerAction('stop');dispatch({type:'PREV_SLIDE'})}
  function navNext(){stopTimerSystem();if(onTimerAction)onTimerAction('stop');dispatch({type:'NEXT_SLIDE'})}

  return(
    <div className="mob-shell">
      {/* Top bar */}
      <div className="mob-top">
        <div className="mob-top-section">{state.show.sections[sectionIdx]?state.show.sections[sectionIdx].name:''}</div>
        <div className="mob-top-counter">{state.currentSlide+1}/{flat.length}</div>
      </div>

      {/* Scrollable body */}
      <div className="mob-scroll">
        {/* Section chips */}
        <div className="mob-section-chips" ref={chipsRef}>
          {state.show.sections.map(function(sec,i){
            return <button key={sec.id} className={'mob-chip'+(i===sectionIdx?' active':'')} onClick={function(){dispatch({type:'JUMP_SECTION',payload:i})}}>{sec.name}</button>;
          })}
        </div>

        {/* Current slide */}
        <div className="mob-card">
          <div className="mob-card-type">{slide.type}</div>
          <div className="mob-card-title">{slide.content.primary||''}</div>
          {slide.content.answer&&<div className="mob-card-answer">{slide.content.answer}</div>}
          {slide.content.source&&<div style={{fontSize:10,color:'var(--text-disabled)',textAlign:'center',marginTop:4}}>{slide.content.source}</div>}
          {slide.content.secondary&&<div style={{fontSize:10,color:'var(--text-disabled)',textAlign:'center',marginTop:4}}>{slide.content.secondary}</div>}
          <div style={{textAlign:'center'}}>
            <span className={'mob-reveal '+(revealed?'revealed':'hidden')} onClick={function(){dispatch({type:'TOGGLE_REVEAL'})}}>{revealed?'REVEALED':'HIDDEN'}</span>
          </div>
          {slide.host_notes&&<div className="mob-card-notes">// {slide.host_notes}</div>}
        </div>

        {/* Next slide preview */}
        <div className="mob-next">
          <div className="mob-next-label">NEXT</div>
          {nextSlide
            ?<div><div style={{fontSize:10,color:'var(--text-secondary)',textTransform:'uppercase',letterSpacing:'.08em'}}>{nextSlide.type}</div><div className="mob-next-text">{nextSlide.content.primary||''}</div></div>
            :<div style={{fontSize:10,color:'var(--text-disabled)'}}>END OF SHOW</div>
          }
        </div>

        {/* Scores */}
        <div className="mob-scores">
          <div className="mob-score-team">
            <div className="mob-score-label" style={{color:'var(--text-secondary)'}}>CYAN</div>
            <div className="mob-score-val" style={{color:'var(--cyan)',textShadow:'var(--glow-cyan)'}}>{state.scores[0]}</div>
            <div className="mob-score-btns">
              <button className="mob-score-btn" onClick={function(){dispatch({type:'SCORE_CYAN',payload:-1})}}>-</button>
              <button className="mob-score-btn" onClick={function(){dispatch({type:'SCORE_CYAN',payload:1})}}>+</button>
            </div>
          </div>
          <div className="mob-score-team">
            <div className="mob-score-label" style={{color:'var(--text-secondary)'}}>PINK</div>
            <div className="mob-score-val" style={{color:'var(--signal)',textShadow:'var(--glow-signal)'}}>{state.scores[1]}</div>
            <div className="mob-score-btns">
              <button className="mob-score-btn" onClick={function(){dispatch({type:'SCORE_PINK',payload:-1})}}>-</button>
              <button className="mob-score-btn" onClick={function(){dispatch({type:'SCORE_PINK',payload:1})}}>+</button>
            </div>
          </div>
        </div>

        {/* Timer */}
        <TimerDisplay onTimerAction={onTimerAction} autoAdvanceRef={autoAdvanceRef} autoTimerDuration={autoTimerDuration} dispatch={dispatch}/>

        {/* Controls */}
        <div style={{marginTop:'var(--space-03)'}}>
          <AutoToggles autoTimer={autoTimer} autoAdvance={autoAdvance} setAutoTimer={setAutoTimer} setAutoAdvance={setAutoAdvance} muted={state.muted} onToggleMute={function(){dispatch({type:'TOGGLE_MUTE'})}}/>
        </div>

        {/* Setlist editor button */}
        <div style={{marginTop:'var(--space-03)'}}>
          <button className="setlist-btn" onClick={function(){dispatch({type:'TOGGLE_SETLIST_EDITOR'})}} style={{width:'100%',padding:'10px 12px',fontSize:11}}>{state.liveMode?'LIVE \uD83D\uDD34':'SETLIST EDITOR'}</button>
        </div>

        {/* Red flag form */}
        <div style={{marginTop:'var(--space-03)'}}>
          <RedFlagForm redFlags={state.redFlags} dispatch={dispatch}/>
        </div>

        {/* Connection + Sign out */}
        <div style={{marginTop:'var(--space-03)',display:'flex',alignItems:'center',justifyContent:'space-between'}}>
          <ConnectionSignal/>
          <button className="mob-signout" onClick={function(){if(fbauth)fbauth.signOut()}}>SIGN OUT</button>
        </div>
      </div>

      {/* Bottom nav */}
      <div className="mob-bottom">
        <button className="mob-nav-btn" onClick={navPrev}>&larr; PREV</button>
        <div className="mob-nav-divider"></div>
        <button className="mob-nav-btn primary" onClick={navNext}>NEXT &rarr;</button>
      </div>
      {state.showSetlistEditor&&<SetlistEditor show={state.show} dispatch={dispatch} liveMode={state.liveMode}/>}
    </div>
  );
}

function SetlistEditor({show,dispatch,liveMode}){
  const sectionRefs=useRef([]);
  const sortableInstances=useRef([]);
  const[swapOpen,setSwapOpen]=useState(null); // {si,sli}
  const[saveName,setSaveName]=useState('');
  const[showLoad,setShowLoad]=useState(false);
  const[showImport,setShowImport]=useState(false);
  const[importText,setImportText]=useState('');
  const[importErr,setImportErr]=useState('');
  const[savedList,setSavedList]=useState(function(){try{return JSON.parse(localStorage.getItem('lineconic_setlists'))||[]}catch(e){return[]}});
  const[firebaseShows,setFirebaseShows]=useState([]);
  const[fbLoading,setFbLoading]=useState(false);
  const fileRef=useRef(null);

  // Attach SortableJS to each section
  useEffect(function(){
    if(liveMode)return;
    sortableInstances.current.forEach(function(s){if(s)try{s.destroy()}catch(e){}});
    sortableInstances.current=[];
    sectionRefs.current.forEach(function(el,si){
      if(!el)return;
      var inst=new Sortable(el,{
        animation:0,
        ghostClass:'sortable-ghost',
        chosenClass:'sortable-chosen',
        handle:'.setlist-slide-grip',
        onEnd:function(evt){
          var sec=show.sections[si];
          var slides=sec.slides.slice();
          var moved=slides.splice(evt.oldIndex,1)[0];
          slides.splice(evt.newIndex,0,moved);
          dispatch({type:'REORDER_SLIDES',payload:{sectionIndex:si,newOrder:slides}});
        }
      });
      sortableInstances.current.push(inst);
    });
    return function(){sortableInstances.current.forEach(function(s){if(s)try{s.destroy()}catch(e){}});sortableInstances.current=[]};
  },[show.sections,liveMode]);

  // Fetch Firebase show index when LOAD dropdown opens
  useEffect(function(){
    if(!showLoad||!fbdb)return;
    setFbLoading(true);
    fbdb.ref('show_index').orderByChild('created').once('value',function(snap){
      var list=[];
      snap.forEach(function(child){list.push({id:child.key,name:child.val().name,created:child.val().created,templateId:child.val().templateId})});
      list.reverse();
      setFirebaseShows(list);
      setFbLoading(false);
    },function(err){
      console.warn('show_index fetch failed',err);
      // Backfill: if show_index doesn't exist, read shows/ directly
      fbdb.ref('shows').once('value',function(showsSnap){
        var backfillUpdates={};var backfillList=[];
        showsSnap.forEach(function(child){
          var s=child.val();
          if(s&&s.name){
            backfillUpdates['show_index/'+child.key]={name:s.name,created:s.created||0,templateId:s.templateId||null};
            backfillList.push({id:child.key,name:s.name,created:s.created||0,templateId:s.templateId||null});
          }
        });
        if(Object.keys(backfillUpdates).length>0)fbdb.ref().update(backfillUpdates).catch(function(){});
        backfillList.sort(function(a,b){return(b.created||0)-(a.created||0)});
        setFirebaseShows(backfillList);
        setFbLoading(false);
      });
    });
  },[showLoad]);

  function handleSwap(si,sli,alt){
    dispatch({type:'SWAP_SLIDE',payload:{sectionIndex:si,slideIndex:sli,newSlide:alt}});
    setSwapOpen(null);
  }

  function handleSave(){
    if(!saveName.trim())return;
    var entry={name:saveName.trim(),savedAt:Date.now(),showId:show.id,sections:show.sections};
    var list=savedList.concat([entry]);
    localStorage.setItem('lineconic_setlists',JSON.stringify(list));
    setSavedList(list);
    setSaveName('');
  }

  function handleLoad(entry){
    var restored={id:entry.showId||show.id,name:show.name,sections:entry.sections,created:show.created};
    dispatch({type:'IMPORT_SHOW',payload:restored});
    setShowLoad(false);
  }

  function handleDeleteSave(idx){
    var list=savedList.filter(function(_,i){return i!==idx});
    localStorage.setItem('lineconic_setlists',JSON.stringify(list));
    setSavedList(list);
  }

  function handleLoadFirebase(showId){
    if(!fbdb)return;
    fbdb.ref('shows/'+showId).once('value',function(snap){
      var showData=snap.val();
      if(!showData||!showData.sections){alert('SHOW DATA MISSING');return}
      dispatch({type:'IMPORT_SHOW',payload:showData});
      try{localStorage.setItem('lineconic_show',JSON.stringify(showData))}catch(e){}
      fbdb.ref('active_show').set(showId).catch(function(){});
      setShowLoad(false);
    });
  }

  function handleDeleteFirebase(showId){
    if(!fbdb)return;
    var isActive=show.id===showId;
    var msg='DELETE THIS SHOW FROM FIREBASE?';
    if(isActive)msg+='\n\nWARNING: THIS IS THE CURRENTLY ACTIVE SHOW.';
    if(!confirm(msg))return;
    var updates={};
    updates['shows/'+showId]=null;
    updates['show_index/'+showId]=null;
    fbdb.ref().update(updates).then(function(){
      setFirebaseShows(function(prev){return prev.filter(function(s){return s.id!==showId})});
    }).catch(function(e){alert('DELETE FAILED: '+e.message)});
  }

  function handleLoadDefault(){
    fetch('/ros-v1.json').then(function(r){return r.json()}).then(function(showData){
      dispatch({type:'IMPORT_SHOW',payload:showData});
      try{localStorage.setItem('lineconic_show',JSON.stringify(showData))}catch(e){}
      if(fbdb)fbdb.ref('active_show').set(showData.id).catch(function(){});
      setShowLoad(false);
    }).catch(function(){alert('FAILED TO LOAD DEFAULT SHOW')});
  }

  function parseImport(raw){
    setImportErr('');
    try{
      var obj=JSON.parse(raw);
      if(!obj.sections||!Array.isArray(obj.sections)){setImportErr('MISSING SECTIONS ARRAY');return}
      if(!obj.id&&!obj.name){setImportErr('MISSING ID OR NAME');return}
      dispatch({type:'IMPORT_SHOW',payload:obj});
      localStorage.setItem('lineconic_show',JSON.stringify(obj));
      setShowImport(false);setImportText('');
    }catch(e){setImportErr('INVALID JSON: '+e.message)}
  }

  function handleFile(e){
    var f=e.target.files[0];if(!f)return;
    var reader=new FileReader();
    reader.onload=function(ev){parseImport(ev.target.result)};
    reader.readAsText(f);
  }

  function handleGoLive(){dispatch({type:'SET_LIVE_MODE'})}

  function slideLabel(s){
    var p=s.content&&s.content.primary||'';
    if(p.length>60)p=p.slice(0,57)+'...';
    return p;
  }

  return(
    <div className="setlist-overlay" onClick={function(e){if(e.target===e.currentTarget)dispatch({type:'TOGGLE_SETLIST_EDITOR'})}}>
      <div className="setlist-header">
        <div className="setlist-title">SETLIST EDITOR</div>
        <div style={{display:'flex',alignItems:'center',gap:'var(--space-03)'}}>
          {liveMode&&<div className="setlist-lock-badge">LOCKED — LIVE</div>}
          <button className="setlist-close" onClick={function(){dispatch({type:'TOGGLE_SETLIST_EDITOR'})}}>CLOSE</button>
        </div>
      </div>
      <div className={'setlist-body'+(liveMode?' setlist-locked':'')}>
        {show.sections.map(function(sec,si){
          return(
            <div className="setlist-section" key={sec.id||si}>
              <div className="setlist-section-head">
                <span className="setlist-section-name">{sec.name}</span>
                <span className="setlist-section-count">{sec.slides.length}</span>
              </div>
              <div ref={function(el){sectionRefs.current[si]=el}}>
                {sec.slides.map(function(slide,sli){
                  var hasAlts=slide.alternates&&slide.alternates.length>0;
                  var isSwapOpen=swapOpen&&swapOpen.si===si&&swapOpen.sli===sli;
                  return(
                    <div className="setlist-slide" key={slide.id||si+'-'+sli} data-id={slide.id}>
                      <div className="setlist-slide-grip">&#x2807;</div>
                      <div className="setlist-slide-type">{slide.type.replace(/_/g,' ')}</div>
                      <div className="setlist-slide-text">{slideLabel(slide)}</div>
                      {slide.content&&slide.content.answer&&<div className="setlist-slide-answer">{slide.content.answer}</div>}
                      <div className="setlist-slide-actions">
                        {hasAlts&&<div style={{position:'relative'}}>
                          <button className={'setlist-btn'+(isSwapOpen?' accent':'')} onClick={function(){setSwapOpen(isSwapOpen?null:{si:si,sli:sli})}}>SWAP</button>
                          {isSwapOpen&&<div className="setlist-alt-popup">
                            {slide.alternates.map(function(alt,ai){
                              return <div className="setlist-alt-item" key={alt.id||ai} onClick={function(){handleSwap(si,sli,alt)}}>
                                <span style={{flex:1}}>{alt.content&&alt.content.primary||alt.id}</span>
                                {alt.content&&alt.content.answer&&<span style={{color:'var(--text-disabled)',fontSize:9}}>{alt.content.answer}</span>}
                              </div>;
                            })}
                          </div>}
                        </div>}
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          );
        })}
      </div>
      <div className="setlist-footer">
        <input className="setlist-input" placeholder="Setlist name..." value={saveName} onChange={function(e){setSaveName(e.target.value)}} onKeyDown={function(e){if(e.key==='Enter')handleSave()}}/>
        <button className="setlist-btn accent" onClick={handleSave} disabled={!saveName.trim()}>SAVE</button>
        <div style={{position:'relative'}}>
          <button className="setlist-btn" onClick={function(){setShowLoad(!showLoad);setShowImport(false)}}>LOAD</button>
          {showLoad&&<div className="setlist-load-list">
            {savedList.length>0&&<div>
              <div className="setlist-load-section-head">SAVED SETLISTS</div>
              {savedList.map(function(entry,i){
                return <div className="setlist-load-item" key={'local-'+i}>
                  <span onClick={function(){handleLoad(entry)}} style={{flex:1,cursor:'pointer'}}>{entry.name}</span>
                  <span style={{color:'var(--text-disabled)',fontSize:9}}>{new Date(entry.savedAt).toLocaleDateString()}</span>
                  <button className="setlist-load-del" onClick={function(e){e.stopPropagation();handleDeleteSave(i)}}>&times;</button>
                </div>;
              })}
            </div>}
            <div className="setlist-load-section-head">SHOWS{fbLoading?' ...':''}</div>
            {!fbdb&&<div style={{padding:8,color:'var(--text-disabled)',fontSize:10}}>FIREBASE OFFLINE</div>}
            {fbdb&&firebaseShows.length===0&&!fbLoading&&<div style={{padding:8,color:'var(--text-disabled)',fontSize:10}}>NO SHOWS IN FIREBASE</div>}
            {firebaseShows.map(function(entry){
              var isActive=show.id===entry.id;
              return <div className={'setlist-load-item'+(isActive?' active':'')} key={'fb-'+entry.id}>
                <span onClick={function(){handleLoadFirebase(entry.id)}} style={{flex:1,cursor:'pointer'}}>{entry.name||entry.id}</span>
                <span className="setlist-load-badge">FB</span>
                <span style={{color:'var(--text-disabled)',fontSize:9}}>{entry.created?new Date(entry.created).toLocaleDateString():''}</span>
                <button className="setlist-load-del" onClick={function(e){e.stopPropagation();handleDeleteFirebase(entry.id)}}>&times;</button>
              </div>;
            })}
            <div className="setlist-load-section-head">DEFAULT</div>
            <div className="setlist-load-item" key="default">
              <span onClick={handleLoadDefault} style={{flex:1,cursor:'pointer'}}>THE SPLIT — TABLE FORMAT V3</span>
              <span className="setlist-load-badge default">DEFAULT</span>
            </div>
          </div>}
        </div>
        <div style={{position:'relative'}}>
          <button className="setlist-btn" onClick={function(){setShowImport(!showImport);setShowLoad(false)}}>IMPORT</button>
          {showImport&&<div className="setlist-alt-popup" style={{width:320,right:0,bottom:'100%',marginBottom:8}}>
            <div style={{padding:'8px 12px',borderBottom:'1px solid var(--border-subtle)'}}>
              <button className="setlist-btn" onClick={function(){fileRef.current&&fileRef.current.click()}} style={{width:'100%',marginBottom:8}}>CHOOSE FILE</button>
              <input ref={fileRef} type="file" accept=".json" style={{display:'none'}} onChange={handleFile}/>
              <textarea className="setlist-import-textarea" placeholder="Or paste JSON here..." value={importText} onChange={function(e){setImportText(e.target.value);setImportErr('')}} rows={4}/>
              <button className="setlist-btn accent" onClick={function(){parseImport(importText)}} style={{width:'100%',marginTop:4}} disabled={!importText.trim()}>IMPORT JSON</button>
              {importErr&&<div className="setlist-import-error">{importErr}</div>}
            </div>
          </div>}
        </div>
        <div style={{marginLeft:'auto'}}>
          {!liveMode&&<button className="setlist-live-btn" onClick={handleGoLive}>GO LIVE</button>}
        </div>
      </div>
    </div>
  );
}

function OperatorView({state,dispatch,onTimerAction,autoTimer,autoAdvance,setAutoTimer,setAutoAdvance,autoAdvanceRef,autoTimerDuration}){
  // Mobile detection
  const[isMobile,setIsMobile]=useState(function(){return window.matchMedia('(max-width:768px),(max-height:500px)').matches});
  useEffect(function(){
    var mq=window.matchMedia('(max-width:768px),(max-height:500px)');
    var handler=function(e){setIsMobile(e.matches)};
    mq.addEventListener('change',handler);
    return function(){mq.removeEventListener('change',handler)};
  },[]);

  const flat=useMemo(()=>flattenSlides(state.show,state.redFlags),[state.show,state.redFlags]);
  const slide=flat[state.currentSlide];
  const nextSlide=flat[state.currentSlide+1]||null;

  if(!slide)return <div className="operator-grid"><div style={{color:'var(--text-secondary)',padding:'var(--space-04)'}}>LOADING...</div></div>;

  if(isMobile)return <MobileOperatorLayout state={state} dispatch={dispatch} flat={flat} slide={slide} nextSlide={nextSlide} onTimerAction={onTimerAction} autoTimer={autoTimer} autoAdvance={autoAdvance} setAutoTimer={setAutoTimer} setAutoAdvance={setAutoAdvance} autoAdvanceRef={autoAdvanceRef} autoTimerDuration={autoTimerDuration}/>;

  return (
    <div className="operator-grid">
      <SectionNav show={state.show} currentSlide={state.currentSlide} dispatch={dispatch} redFlags={state.redFlags}/>
      <div className="operator-main">
        <CurrentSlideCard slide={slide} slideIndex={state.currentSlide} totalSlides={flat.length} revealState={state.revealState} dispatch={dispatch}/>
        <NextSlideCard slide={nextSlide}/>
      </div>
      <div className="operator-right">
        <ConnectionSignal/>
        <button className="setlist-btn" onClick={function(){dispatch({type:'TOGGLE_SETLIST_EDITOR'})}} style={{width:'100%',padding:'8px 12px',fontSize:11,marginBottom:'var(--space-02)'}}>{state.liveMode?'LIVE \uD83D\uDD34':'SETLIST [L]'}</button>
        <QuickAccessButtons/>
        <RedFlagForm redFlags={state.redFlags} dispatch={dispatch}/>
        <AutoToggles autoTimer={autoTimer} autoAdvance={autoAdvance} setAutoTimer={setAutoTimer} setAutoAdvance={setAutoAdvance} muted={state.muted} onToggleMute={()=>dispatch({type:'TOGGLE_MUTE'})}/>
        <ScoreDisplay scores={state.scores} dispatch={dispatch}/>
        <TimerDisplay onTimerAction={onTimerAction} autoAdvanceRef={autoAdvanceRef} autoTimerDuration={autoTimerDuration} dispatch={dispatch}/>
        <div style={{marginTop:'auto',display:'flex',flexDirection:'column',gap:'var(--space-02)',alignItems:'center',width:'100%'}}>
          <div style={{fontFamily:"'Space Mono',monospace",fontSize:'var(--type-meta)',color:'var(--text-disabled)',textAlign:'center'}}>PRESS ? FOR SHORTCUTS</div>
          <button onClick={function(){if(fbauth)fbauth.signOut()}} style={{
            background:'transparent',
            border:'1px solid var(--border-subtle)',
            color:'var(--text-disabled)',
            fontFamily:"'Space Mono',monospace",
            fontSize:10,
            letterSpacing:'.06em',
            textTransform:'uppercase',
            padding:'4px 12px',
            cursor:'pointer',
            width:'100%'
          }}>SIGN OUT</button>
        </div>
      </div>
      <div className="operator-bottom">
        <button className="receipt-counter" onClick={()=>dispatch({type:'INCREMENT_RECEIPTS'})} style={{cursor:'pointer',background:'transparent',border:'1px solid var(--border-subtle)'}}>RECEIPTS: {state.receipts} +</button>
        <div data-testid="slide-counter" style={{fontFamily:"'Space Mono',monospace",fontSize:'var(--type-meta)',color:'var(--text-secondary)'}}>{state.currentSlide+1}/{flat.length}</div>
      </div>
      {state.showShortcuts&&<ShortcutOverlay onClose={()=>dispatch({type:'CLOSE_OVERLAYS'})}/>}
      {state.showSetlistEditor&&<SetlistEditor show={state.show} dispatch={dispatch} liveMode={state.liveMode}/>}
    </div>
  );
}

// ═══════════════════════════════════════
// VOTE VIEW (audience phone voting)
// ═══════════════════════════════════════
function VoteView(){
  const[topic,setTopic]=useState(null);
  const[voteData,setVoteData]=useState({dead:0,alive:0});
  const[voted,setVoted]=useState(null);
  const[flash,setFlash]=useState(null);

  useEffect(()=>{
    if(!fbdb)return;
    const topicRef=fbdb.ref('currentTopic');
    topicRef.on('value',snap=>{
      const t=snap.val();
      setTopic(t);
      setVoted(null);
      setVoteData({dead:0,alive:0});
    });
    return()=>topicRef.off();
  },[]);

  useEffect(()=>{
    if(!fbdb||!topic)return;
    const key=topic.replace(/[^a-zA-Z0-9]/g,'_');
    const voteRef=fbdb.ref('votes/'+key);
    voteRef.on('value',snap=>{
      const v=snap.val()||{};
      setVoteData({dead:v.dead||0,alive:v.alive||0});
    });
    return()=>voteRef.off();
  },[topic]);

  function doVote(side){
    if(voted||!topic)return;
    setVoted(side);
    setFlash(side);
    setTimeout(()=>setFlash(null),300);
    const key=topic.replace(/[^a-zA-Z0-9]/g,'_');
    if(fbdb)fbdb.ref('votes/'+key+'/'+side).transaction(c=>(c||0)+1);
  }

  const total=voteData.dead+voteData.alive;
  const deadPct=total?Math.round(voteData.dead/total*100):50;
  const alivePct=total?100-deadPct:50;
  const waiting=!topic;

  return(
    <div data-testid="vote-view" style={{background:'#000',color:'#fff',fontFamily:"'Anton','Impact',sans-serif",minHeight:'100vh',display:'flex',alignItems:'center',justifyContent:'center'}}>
      <div style={{maxWidth:420,padding:'40px 24px',textAlign:'center',width:'100%'}}>
        <div style={{fontSize:72,color:'var(--signal)',textShadow:'0 0 10px rgba(255,0,127,.9),0 0 30px rgba(255,0,127,.5),0 0 60px rgba(255,0,127,.2)',marginBottom:8,letterSpacing:'.08em'}}>L</div>
        <div style={{fontFamily:"'Space Mono',monospace",fontSize:10,color:'rgba(255,255,255,.3)',letterSpacing:'.15em',textTransform:'uppercase',marginBottom:48}}>DEAD OR ALIVE</div>
        <div style={{fontSize:14,fontFamily:"'Space Mono',monospace",color:'rgba(255,255,255,.5)',letterSpacing:'.1em',textTransform:'uppercase',marginBottom:24}}>IS THIS CULTURALLY...</div>
        <div data-testid="vote-topic" style={{fontSize:'clamp(36px,10vw,56px)',textTransform:'uppercase',letterSpacing:'.04em',color:waiting?'rgba(255,255,255,.15)':'#fff',textShadow:waiting?'none':'0 0 10px rgba(255,255,255,.6),0 0 30px rgba(255,255,255,.3)',marginBottom:40,lineHeight:1.1,transition:'all .3s'}}>{topic||'WAITING FOR HOST...'}</div>
        <div style={{display:'flex',gap:16,width:'100%',marginBottom:32,opacity:waiting?.15:1,pointerEvents:waiting?'none':'auto'}}>
          <button onClick={()=>doVote('dead')} data-testid="vote-dead" style={{flex:1,padding:'24px 16px',fontFamily:"'Anton',sans-serif",fontSize:28,letterSpacing:'.08em',cursor:'pointer',textTransform:'uppercase',background:flash==='dead'?'#FF007F':'transparent',color:flash==='dead'?'#000':'#FF007F',border:'2px solid #FF007F',boxShadow:'0 0 12px rgba(255,0,127,.3)',opacity:voted&&voted!=='dead'?.15:1,pointerEvents:voted?'none':'auto'}}>DEAD</button>
          <button onClick={()=>doVote('alive')} data-testid="vote-alive" style={{flex:1,padding:'24px 16px',fontFamily:"'Anton',sans-serif",fontSize:28,letterSpacing:'.08em',cursor:'pointer',textTransform:'uppercase',background:flash==='alive'?'#00FFFF':'transparent',color:flash==='alive'?'#000':'#00FFFF',border:'2px solid #00FFFF',boxShadow:'0 0 12px rgba(0,255,255,.3)',opacity:voted&&voted!=='alive'?.15:1,pointerEvents:voted?'none':'auto'}}>ALIVE</button>
        </div>
        <div style={{width:'100%',marginBottom:16}}>
          <div style={{display:'flex',justifyContent:'space-between',marginBottom:6}}>
            <span style={{fontFamily:"'Space Mono',monospace",fontSize:11,letterSpacing:'.08em',color:'#FF007F'}}>{voteData.dead} DEAD</span>
            <span style={{fontFamily:"'Space Mono',monospace",fontSize:11,letterSpacing:'.08em',color:'#00FFFF'}}>{voteData.alive} ALIVE</span>
          </div>
          <div style={{width:'100%',height:8,background:'rgba(255,255,255,.05)',position:'relative',overflow:'hidden'}}>
            <div style={{position:'absolute',left:0,top:0,bottom:0,width:deadPct+'%',background:'linear-gradient(90deg,#FF007F,rgba(255,0,127,.3))',transition:'width .4s ease'}}/>
            <div style={{position:'absolute',right:0,top:0,bottom:0,width:alivePct+'%',background:'linear-gradient(270deg,#00FFFF,rgba(0,255,255,.3))',transition:'width .4s ease'}}/>
          </div>
        </div>
        <div style={{display:'flex',justifyContent:'space-between'}}>
          <span style={{fontSize:'clamp(24px,6vw,36px)',fontFamily:"'Space Mono',monospace",color:'#FF007F',textShadow:'0 0 8px rgba(255,0,127,.4)'}}>{deadPct}%</span>
          <span style={{fontSize:'clamp(24px,6vw,36px)',fontFamily:"'Space Mono',monospace",color:'#00FFFF',textShadow:'0 0 8px rgba(0,255,255,.4)'}}>{alivePct}%</span>
        </div>
        {voted&&<div style={{fontFamily:"'Space Mono',monospace",fontSize:11,color:'rgba(255,255,255,.3)',marginTop:24,letterSpacing:'.08em',textTransform:'uppercase'}}>VOTE CAST — {voted.toUpperCase()}</div>}
      </div>
    </div>
  );
}

// ═══════════════════════════════════════
// ANSWERS VIEW — uses DOM API for perf (avoids Babel JSX overhead)
// ═══════════════════════════════════════
function buildAnswersHTML(show){
  const secs=show.sections||[];
  let h='<h1 class="ans-h1">HOST ANSWER SHEET</h1><div class="ans-sub">LINECONIC LIVE — FOR HOST EYES ONLY</div>';
  secs.forEach(function(sec){
    const sl=sec.slides||[];const types=sl.map(function(s){return s.type});
    const ts=sl.find(function(s){return s.type==='round_title'||s.type==='tier_title'});
    const desc=ts&&ts.content&&ts.content.secondary?(ts.content.secondary||'').replace(/\|/g,' '):'';
    const hdr='<div class="ans-rt">'+esc(sec.name)+'</div>'+(desc?'<div class="ans-rd">'+esc(desc)+'</div>':'');
    if(types.includes('fluency_line')){
      let g='';for(let i=0;i<sl.length;i++){if(sl[i].type==='fluency_line'){const src=sl[i+1]&&sl[i+1].type==='fluency_source'?sl[i+1].content.primary:'';g+='<div class="ans-pair"><span>'+esc(sl[i].content.primary||'')+'</span><span class="ans-dim">'+esc(src)+'</span></div>';}}
      h+='<div class="ans-sec">'+hdr+'<div class="ans-grid2">'+g+'</div></div>';return;
    }
    if(types.includes('doa_vote')){
      let g='';for(let i=0;i<sl.length;i++){if(sl[i].type==='doa_vote'){let v='',c='';for(let j=i+1;j<sl.length&&j<i+4;j++){if(sl[j].type==='doa_verdict_dead'){v='DEAD';c='ans-pk';break}if(sl[j].type==='doa_verdict_alive'){v='ALIVE';c='ans-cy';break}}g+='<div class="ans-pair"><span>'+esc(sl[i].content.primary||'')+'</span><span class="'+c+' ans-bold">'+v+'</span></div>';}}
      h+='<div class="ans-sec">'+hdr+'<div class="ans-grid2">'+g+'</div></div>';return;
    }
    if(types.includes('hotseat_prompt')){
      let g='';sl.forEach(function(s){if(s.type==='hotseat_prompt')g+='<div class="ans-pair"><span>'+esc(s.content.primary||'')+'</span><span class="ans-dim">'+esc(s.content.source||'')+'</span></div>';});
      h+='<div class="ans-sec">'+hdr+g+'</div>';return;
    }
    if(types.includes('verdict')||types.includes('sentence')){
      let g='';sl.forEach(function(s){if(s.type==='verdict'||s.type==='sentence'){g+='<div class="ans-dim" style="margin-bottom:6px">'+esc(s.content.primary||'')+'</div>';(s.content.secondary||'').split('|').forEach(function(l){if(l.trim())g+='<div class="ans-pk ans-bold" style="margin-bottom:6px">'+esc(l.trim())+'</div>';});}});
      h+='<div class="ans-sec">'+hdr+g+'</div>';return;
    }
    if(types.includes('source_q')||types.includes('acronym_q')){
      const isAcr=types.includes('acronym_q');const qt=isAcr?'acronym_q':'source_q';
      let rows='',qn=0,bonus=null;
      sl.forEach(function(s){
        if(s.type==='bonus_marker'){bonus=s.content.primary||'BONUS';rows+='<tr><td colspan="4" style="padding:12px 8px 4px"><span class="ans-gd" style="font-size:10px;letter-spacing:.08em">&#9733; '+esc(bonus)+'</span></td></tr>';return;}
        if(s.type===qt){qn++;const c=s.content;const bg=bonus?' style="background:rgba(255,215,0,.06)"':'';const nc=bonus?'ans-gd':'ans-dim';const sc=isAcr?' ans-cy':'';const ansCol=isAcr?esc(c.answer||'—'):'—';const srcCol=isAcr?esc(c.source||''):esc(c.answer||'');rows+='<tr'+bg+'><td class="ans-td '+nc+'" style="width:30px;text-align:right;padding-right:12px">'+qn+'</td><td class="ans-td'+sc+'">'+esc(c.primary||'')+'</td><td class="ans-td">'+ansCol+'</td><td class="ans-td ans-pk" style="width:180px">'+srcCol+'</td></tr>';bonus=null;}
      });
      h+='<div class="ans-sec">'+hdr+'<table class="ans-tbl"><thead><tr><th class="ans-th">#</th><th class="ans-th">SHOWN</th><th class="ans-th">ANSWER</th><th class="ans-th">SOURCE</th></tr></thead><tbody>'+rows+'</tbody></table></div>';
    }
  });
  return h;
}
function AnswersView({show}){
  const ref=useRef(null);
  useEffect(function(){document.body.classList.add('answers-mode');return function(){document.body.classList.remove('answers-mode')}},[]);
  useEffect(function(){if(show&&ref.current)ref.current.innerHTML=buildAnswersHTML(show)},[show]);
  if(!show)return <div data-testid="answers-view" style={{background:'#000',color:'var(--signal)',padding:40,fontFamily:"'Space Mono',monospace"}}>LOADING...</div>;
  return <div data-testid="answers-view" className="answers-wrap" ref={ref}></div>;
}

// ═══════════════════════════════════════
// AUTH VIEWS
// ═══════════════════════════════════════
function AuthLoadingView(){
  return(
    <div style={{
      position:'fixed',inset:0,
      background:'var(--void)',
      display:'flex',alignItems:'center',justifyContent:'center',
      fontFamily:"'Space Mono','Consolas',monospace",
      fontSize:'var(--type-label)',
      color:'var(--text-secondary)',
      letterSpacing:'.1em',
      textTransform:'uppercase'
    }}>
      AUTHENTICATING...
    </div>
  );
}

function LoginView({onLogin}){
  const[email,setEmail]=useState('');
  const[password,setPassword]=useState('');
  const[error,setError]=useState(null);
  const[loading,setLoading]=useState(false);

  function handleSubmit(e){
    e.preventDefault();
    if(!fbauth||loading)return;
    setError(null);
    setLoading(true);
    fbauth.signInWithEmailAndPassword(email,password)
      .then(function(cred){onLogin(cred.user)})
      .catch(function(err){
        setLoading(false);
        switch(err.code){
          case'auth/invalid-email':setError('INVALID EMAIL FORMAT');break;
          case'auth/user-not-found':setError('ACCESS DENIED');break;
          case'auth/wrong-password':setError('WRONG PASSWORD');break;
          case'auth/invalid-credential':setError('INVALID CREDENTIALS');break;
          case'auth/too-many-requests':setError('TOO MANY ATTEMPTS. TRY LATER.');break;
          default:setError('AUTH FAILED: '+err.code);
        }
      });
  }

  return(
    <div style={{
      position:'fixed',inset:0,
      background:'var(--void)',
      display:'flex',flexDirection:'column',
      alignItems:'center',justifyContent:'center',
      gap:'var(--space-05)',
      fontFamily:"'Space Mono','Consolas',monospace"
    }}>
      <div>
        <a href="/" style={{textDecoration:'none'}}><div className="D hp" style={{fontSize:'clamp(32px,8vw,64px)',marginBottom:8,textAlign:'center'}}>LINECONIC</div></a>
        <div className="D hs" style={{fontSize:'clamp(12px,3vw,20px)',letterSpacing:'.2em',textAlign:'center'}}>OPERATOR LOGIN</div>
      </div>
      <form onSubmit={handleSubmit} style={{
        display:'flex',flexDirection:'column',
        gap:'var(--space-03)',
        width:'100%',maxWidth:360,
        padding:'0 var(--space-04)'
      }}>
        <input
          type="email"
          className="login-input"
          value={email}
          onChange={function(e){setEmail(e.target.value)}}
          placeholder="EMAIL"
          autoComplete="email"
          required
          style={{
            background:'var(--surface-02)',
            border:'1px solid var(--border-subtle)',
            color:'var(--text-primary)',
            fontFamily:"'Space Mono',monospace",
            fontSize:'var(--type-label)',
            letterSpacing:'.05em',
            padding:'12px 16px',
            outline:'none',
            width:'100%',
            textTransform:'none'
          }}
          onFocus={function(e){e.target.style.borderColor='var(--signal)';e.target.style.boxShadow='0 0 12px rgba(255,0,127,.3)'}}
          onBlur={function(e){e.target.style.borderColor='var(--border-subtle)';e.target.style.boxShadow='none'}}
        />
        <input
          type="password"
          className="login-input"
          value={password}
          onChange={function(e){setPassword(e.target.value)}}
          placeholder="PASSWORD"
          autoComplete="current-password"
          required
          style={{
            background:'var(--surface-02)',
            border:'1px solid var(--border-subtle)',
            color:'var(--text-primary)',
            fontFamily:"'Space Mono',monospace",
            fontSize:'var(--type-label)',
            letterSpacing:'.05em',
            padding:'12px 16px',
            outline:'none',
            width:'100%'
          }}
          onFocus={function(e){e.target.style.borderColor='var(--signal)';e.target.style.boxShadow='0 0 12px rgba(255,0,127,.3)'}}
          onBlur={function(e){e.target.style.borderColor='var(--border-subtle)';e.target.style.boxShadow='none'}}
        />
        <button type="submit" disabled={loading} style={{
          background:loading?'var(--surface-03)':'var(--signal)',
          border:'none',
          color:loading?'var(--text-disabled)':'var(--void)',
          fontFamily:"'Space Mono',monospace",
          fontSize:'var(--type-label)',
          fontWeight:700,
          letterSpacing:'.1em',
          textTransform:'uppercase',
          padding:'14px 24px',
          cursor:loading?'wait':'pointer',
          boxShadow:loading?'none':'var(--glow-signal)',
          transition:'all .15s'
        }}>
          {loading?'SIGNING IN...':'SIGN IN'}
        </button>
        {error&&<div style={{
          color:'var(--signal)',
          fontSize:'var(--type-meta)',
          letterSpacing:'.06em',
          textAlign:'center',
          textShadow:'0 0 8px rgba(255,0,127,.5)'
        }}>{error}</div>}
      </form>
    </div>
  );
}

// ═══════════════════════════════════════
// APP (root component)
// ═══════════════════════════════════════
function App(){
  const params=new URLSearchParams(window.location.search);
  const pathMode={'/operator':'operator','/audience':'audience','/vote':'vote','/answers':'answers'}[window.location.pathname];
  const mode=pathMode||params.get('mode')||'launcher';
  const isLauncher=mode==='launcher';
  const isAudience=mode==='audience';
  const isVote=mode==='vote';
  const isAnswers=mode==='answers';

  // Auth state for protected routes
  const needsAuth=mode==='operator'||mode==='answers';
  const[authUser,setAuthUser]=useState(null);
  const[authLoading,setAuthLoading]=useState(needsAuth);

  useEffect(function(){
    if(!needsAuth||!fbauth){setAuthLoading(false);return}
    var unsub=fbauth.onAuthStateChanged(function(user){
      setAuthUser(user);
      setAuthLoading(false);
    });
    return function(){unsub()};
  },[]);

  // Load saved state from localStorage
  const savedState=useMemo(()=>{
    try{const s=JSON.parse(localStorage.getItem('lineconic_state'));if(s)return{...initialState,...s}}catch(e){}
    return initialState;
  },[]);

  const[state,dispatch]=useReducer(reducer,savedState);
  const stateRef=useRef(state);
  stateRef.current=state;
  const[autoTimer,setAutoTimer]=useState(false);
  const[autoAdvance,setAutoAdvance]=useState(false);
  const autoTimerRef=useRef(false);
  const autoAdvanceRef=useRef(false);
  autoTimerRef.current=autoTimer;
  autoAdvanceRef.current=autoAdvance;
  const autoTimerDuration=useRef(30);
  const[rewardTier,setRewardTier]=useState(null);

  // Load show data
  // Priority: localStorage (same session) → Firebase active_show (cross-device) → ros-v1.json (default)
  useEffect(()=>{
    if(state.show)return;
    function restoreSlidePos(){try{const s=JSON.parse(localStorage.getItem('lineconic_state'));if(s&&s.currentSlide){dispatch({type:'GO_TO_SLIDE',payload:s.currentSlide})}}catch(e){}}
    function loadShow(show){localStorage.setItem('lineconic_show',JSON.stringify(show));dispatch({type:'SET_SHOW',payload:show});restoreSlidePos()}
    // 1. Try localStorage first (bust cache if version is stale)
    try{
      const cached=localStorage.getItem('lineconic_show');
      if(cached){var cShow=JSON.parse(cached);if(cShow.version&&cShow.version>=2){dispatch({type:'SET_SHOW',payload:cShow});restoreSlidePos();return}}
    }catch(e){}
    // 2. Try Firebase active_show (set by builder PUSH TO FIREBASE)
    if(fbdb){
      fbdb.ref('active_show').once('value',snap=>{
        const activeId=snap.val();
        if(activeId){
          fbdb.ref('shows/'+activeId).once('value',showSnap=>{
            const show=showSnap.val();
            if(show&&show.sections){loadShow(show);return}
            // Active show ID exists but data missing — fall through
            fallbackToStatic();
          });
        }else{
          fallbackToStatic();
        }
      });
    }else{
      fallbackToStatic();
    }
    function fallbackToStatic(){
      // 3. Fetch from ros-v1.json
      fetch('/ros-v1.json').then(r=>r.json()).then(show=>{
        loadShow(show);
        // Seed default to Firebase show_index if not already there
        if(fbdb){
          fbdb.ref('show_index/'+show.id).once('value',snap=>{
            if(!snap.val()){
              var updates={};
              updates['shows/'+show.id]=show;
              updates['show_index/'+show.id]={name:show.name,created:show.created||0,templateId:null};
              fbdb.ref().update(updates).catch(()=>{});
            }
          });
        }
      }).catch(()=>{
        // 4. Last resort: any show in Firebase
        if(fbdb){fbdb.ref('shows').limitToFirst(1).once('value',snap=>{const v=snap.val();if(v){const key=Object.keys(v)[0];loadShow(v[key])}})}
      });
    }
  },[]);

  // Persist state to localStorage on change
  useEffect(()=>{
    const toSave={currentSlide:state.currentSlide,scores:state.scores,revealState:state.revealState,showScoreboard:state.showScoreboard,muted:state.muted,receipts:state.receipts};
    localStorage.setItem('lineconic_state',JSON.stringify(toSave));
  },[state.currentSlide,state.scores,state.revealState,state.showScoreboard,state.muted,state.receipts]);

  // Persist show edits (reorder/swap/import) to localStorage
  useEffect(function(){
    if(state.show)localStorage.setItem('lineconic_show',JSON.stringify(state.show));
  },[state.show]);

  // Load red flags from localStorage on mount
  useEffect(function(){
    try{var saved=JSON.parse(localStorage.getItem('lineconic_redflags'));if(Array.isArray(saved)&&saved.length)dispatch({type:'SET_RED_FLAGS',payload:saved})}catch(e){}
  },[]);

// ═══ SYNC: Operator → Firebase + BroadcastChannel ═══
const bcRef=useRef(null);
const syncSkipRef=useRef(false);

useEffect(()=>{
  try{bcRef.current=new BroadcastChannel('lineconic-ctrl')}catch(e){}
  return()=>{if(bcRef.current)bcRef.current.close()};
},[]);

useEffect(()=>{
  if(mode!=='operator'||!state.show||syncSkipRef.current)return;
  const sync={slide:state.currentSlide,scores:state.scores,revealState:state.revealState,scoreboard:state.showScoreboard,muted:state.muted,rewardTier:rewardTier,redFlags:state.redFlags};
  if(fbdb){fbdb.ref('live/'+state.show.id+'/state').set(sync).catch(()=>{})}
  if(bcRef.current){bcRef.current.postMessage({type:'sync',...sync})}
},[state.currentSlide,state.scores,state.revealState,state.showScoreboard,state.muted,rewardTier,state.redFlags]);

// DOA topic push — operator pushes currentTopic on slide change so /vote page works
useEffect(()=>{
  if(mode!=='operator'||!state.show)return;
  const flat=flattenSlides(state.show,state.redFlags);
  const slide=flat[state.currentSlide];
  if(!slide)return;
  if(slide.type==='doa_vote'){pushTopic(slide.content.primary)}
  else if(slide.type!=='doa_verdict_dead'&&slide.type!=='doa_verdict_alive'){pushTopic(null)}
},[state.currentSlide,state.show,state.redFlags]);

useEffect(()=>{
  if(mode==='operator'||!state.show)return;
  const showId=state.show.id;
  let fbUnsub=null;
  if(fbdb){
    const ref=fbdb.ref('live/'+showId+'/state');
    const handler=snap=>{
      const d=snap.val();if(!d)return;
      syncSkipRef.current=true;
      if(d.redFlags)dispatch({type:'SET_RED_FLAGS',payload:d.redFlags,fromSync:true});
      if(d.slide!==undefined)dispatch({type:'GO_TO_SLIDE',payload:d.slide});
      if(d.scores)dispatch({type:'SET_SCORES',payload:d.scores});
      if(d.revealState)dispatch({type:'SET_REVEAL_STATE',payload:d.revealState});
      if(d.scoreboard!==undefined)dispatch({type:'SET_SCOREBOARD',payload:d.scoreboard});
      if(d.muted!==undefined)dispatch({type:'SET_MUTED',payload:d.muted});
      if(d.rewardTier!==undefined)setRewardTier(d.rewardTier);
      syncSkipRef.current=false;
    };
    ref.on('value',handler);
    fbUnsub=()=>ref.off('value',handler);
  }
  const bcHandler=ev=>{
    const d=ev.data;if(d.type!=='sync')return;
    syncSkipRef.current=true;
    if(d.redFlags)dispatch({type:'SET_RED_FLAGS',payload:d.redFlags,fromSync:true});
    if(d.slide!==undefined)dispatch({type:'GO_TO_SLIDE',payload:d.slide});
    if(d.scores)dispatch({type:'SET_SCORES',payload:d.scores});
    if(d.revealState)dispatch({type:'SET_REVEAL_STATE',payload:d.revealState});
    if(d.scoreboard!==undefined)dispatch({type:'SET_SCOREBOARD',payload:d.scoreboard});
    if(d.muted!==undefined)dispatch({type:'SET_MUTED',payload:d.muted});
    if(d.rewardTier!==undefined)setRewardTier(d.rewardTier);
    syncSkipRef.current=false;
  };
  if(bcRef.current)bcRef.current.onmessage=ev=>{
    const d=ev.data;
    if(d.type==='sync')bcHandler(ev);
    if(d.type==='timer')handleTimerMsg(d);
  };
  return()=>{if(fbUnsub)fbUnsub();if(bcRef.current)bcRef.current.onmessage=null};
},[mode,state.show]);

// ═══ TIMER SYNC ═══
const audienceSlideRef=useRef(null);

function broadcastTimerAction(action,duration){
  const s=stateRef.current;
  const msg={type:'timer',action:action,duration:duration||0,timestamp:Date.now()};
  if(fbdb&&s.show)fbdb.ref('live/'+s.show.id+'/timer').set(msg).catch(()=>{});
  if(bcRef.current)bcRef.current.postMessage(msg);
}

function handleTimerMsg(d){
  if(!d||d.type!=='timer')return;
  // Find the .tb element on current audience slide
  const tbEl=audienceSlideRef.current?audienceSlideRef.current.querySelector('.tb'):null;
  switch(d.action){
    case'start':{
      const elapsed=(Date.now()-d.timestamp)/1000;
      const remaining=Math.max(0,d.duration-elapsed);
      if(remaining>0.5)startTimerSystem(remaining,tbEl);
      break;
    }
    case'pause':pauseTimerSystem();break;
    case'resume':resumeTimerSystem();break;
    case'stop':stopTimerSystem();break;
  }
}

// Audience listens for timer events via Firebase
useEffect(()=>{
  if(mode==='operator'||!state.show)return;
  if(!fbdb)return;
  const ref=fbdb.ref('live/'+state.show.id+'/timer');
  const handler=snap=>{
    const d=snap.val();
    if(d)handleTimerMsg(d);
  };
  ref.on('value',handler);
  return()=>ref.off('value',handler);
},[mode,state.show]);

// ═══ AUTO-TIMER: start timer on question slides ═══
useEffect(()=>{
  if(mode!=='operator'||!autoTimerRef.current||!state.show)return;
  const flat=flattenSlides(state.show,state.redFlags);
  const slide=flat[state.currentSlide];
  if(!slide)return;
  const isQ=slide.type==='source_q'||slide.type==='acronym_q'||slide.type==='hotseat_prompt';
  if(!isQ)return;
  const dur=autoTimerDuration.current;
  const onEnd=autoAdvanceRef.current?function(){dispatch({type:'NEXT_SLIDE'})}:null;
  startTimerSystem(dur,null,onEnd);
  broadcastTimerAction('start',dur);
},[state.currentSlide,autoTimer]);

  // Set cursor style for audience mode
  useEffect(()=>{
    if(isAudience)document.body.classList.add('audience-mode');
    return()=>document.body.classList.remove('audience-mode');
  },[isAudience]);

  // Keyboard handler
  useEffect(()=>{
    function handleKey(ev){
      if(ev.target.tagName==='INPUT'||ev.target.tagName==='TEXTAREA')return;
      const s=stateRef.current;
      switch(ev.key){
        case'ArrowRight':case' ':case'PageDown':ev.preventDefault();stopTimerSystem();broadcastTimerAction('stop');dispatch({type:'NEXT_SLIDE'});break;
        case'ArrowLeft':case'PageUp':ev.preventDefault();stopTimerSystem();broadcastTimerAction('stop');dispatch({type:'PREV_SLIDE'});break;
        case'Home':stopTimerSystem();broadcastTimerAction('stop');dispatch({type:'GO_TO_SLIDE',payload:0});break;
        case'End':{const flat=flattenSlides(s.show,s.redFlags);stopTimerSystem();broadcastTimerAction('stop');dispatch({type:'GO_TO_SLIDE',payload:flat.length-1});break}
        case'r':case'R':dispatch({type:'TOGGLE_REVEAL'});break;
        case's':case'S':dispatch({type:'TOGGLE_SCOREBOARD'});break;
        case't':case'T':{const dur=autoTimerDuration.current||30;const onEnd=autoAdvanceRef.current?function(){dispatch({type:'NEXT_SLIDE'})}:null;startTimerSystem(dur,null,onEnd);broadcastTimerAction('start',dur);break}
        case'm':case'M':dispatch({type:'TOGGLE_MUTE'});break;
        case'q':case'Q':dispatch({type:'SCORE_CYAN',payload:1});break;
        case'w':case'W':dispatch({type:'SCORE_CYAN',payload:-1});break;
        case'p':case'P':dispatch({type:'SCORE_PINK',payload:1});break;
        case'o':case'O':dispatch({type:'SCORE_PINK',payload:-1});break;
        case'a':case'A':setAutoTimer(function(v){return!v});break;
        case'd':case'D':setAutoAdvance(function(v){return!v});break;
        case'c':case'C':dispatch({type:'INCREMENT_RECEIPTS'});break;
        case'g':case'G':setRewardTier(function(v){const cycle=[null,'cancel','grind','flop'];const i=cycle.indexOf(v);return cycle[(i+1)%cycle.length]});break;
        case'v':case'V':{const flat=flattenSlides(s.show,s.redFlags);const slide=flat[s.currentSlide];if(slide&&slide.type==='doa_vote'){pushTopic(slide.content.primary||null)}break}
        case'l':case'L':if(!s.liveMode)dispatch({type:'TOGGLE_SETLIST_EDITOR'});break;
        case'f':case'F':if(!document.fullscreenElement)document.documentElement.requestFullscreen();else document.exitFullscreen();break;
        case'?':dispatch({type:'TOGGLE_SHORTCUTS'});break;
        case'Escape':dispatch({type:'CLOSE_OVERLAYS'});break;
        case'1':case'2':case'3':case'4':case'5':case'6':case'7':case'8':case'9':
          if(s.show){const idx=parseInt(ev.key)-1;if(idx<s.show.sections.length)dispatch({type:'JUMP_SECTION',payload:idx})}break;
      }
    }
    window.addEventListener('keydown',handleKey);
    return()=>window.removeEventListener('keydown',handleKey);
  },[]);

  // Public routes — no auth needed
  if(isLauncher)return <LauncherView showName={state.show?state.show.name||state.show.id:null}/>;
  if(isVote)return <VoteView/>;
  if(isAudience){
    if(!state.show)return <div style={{background:'#000',color:'var(--signal)',width:'100vw',height:'100vh',display:'flex',alignItems:'center',justifyContent:'center',fontFamily:"'Space Mono',monospace"}}>LOADING SHOW DATA...</div>;
    return <AudienceView state={state} dispatch={dispatch} slideRef={audienceSlideRef} rewardTier={rewardTier}/>;
  }

  // Auth gate — protected routes (operator, answers)
  if(authLoading)return <AuthLoadingView/>;
  if(needsAuth&&!authUser)return <LoginView onLogin={setAuthUser}/>;

  // Protected routes — user is authenticated
  if(!state.show)return <div style={{background:'#000',color:'var(--signal)',width:'100vw',height:'100vh',display:'flex',alignItems:'center',justifyContent:'center',fontFamily:"'Space Mono',monospace"}}>LOADING SHOW DATA...</div>;
  if(isAnswers)return <AnswersView show={state.show}/>;
  return <OperatorView state={state} dispatch={dispatch} onTimerAction={broadcastTimerAction} autoTimer={autoTimer} autoAdvance={autoAdvance} setAutoTimer={setAutoTimer} setAutoAdvance={setAutoAdvance} autoAdvanceRef={autoAdvanceRef} autoTimerDuration={autoTimerDuration}/>;
}

// ═══════════════════════════════════════
// MOUNT + SERVICE WORKER
// ═══════════════════════════════════════
ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
if('serviceWorker' in navigator){navigator.serviceWorker.register('/sw.js').catch(()=>{})}
</script>
</body>
</html>
